{"version":3,"sources":["../../src/constants.ts","../../src/blocks/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @module @nous/core/constants\n * @description All constants, enums, and configuration values\n * @version 0.1.0\n * @spec Brainstorms/Specs/storm-011/spec/constants.ts\n */\n\n// ============================================================\n// ID CONFIGURATION\n// ============================================================\n\n/** Length of nanoid for globally unique IDs */\nexport const NANOID_LENGTH = 12;\n\n/** Prefix for node IDs: \"n_\" + nanoid(12) */\nexport const NODE_ID_PREFIX = 'n_';\n\n/** Prefix for block IDs: \"b_\" + nanoid(12) */\nexport const BLOCK_ID_PREFIX = 'b_';\n\n/** Prefix for edge IDs: \"e_\" + nanoid(12) */\nexport const EDGE_ID_PREFIX = 'e_';\n\n/** Prefix for edit record IDs: \"edit_\" + nanoid(12) */\nexport const EDIT_ID_PREFIX = 'edit_';\n\n// ============================================================\n// NODE TYPES\n// ============================================================\n\nexport const NODE_TYPES = [\n  'concept',\n  'episode',\n  'document',\n  'section',\n  'chunk',\n  'note',\n  'raw',\n] as const;\n\nexport type NodeType = (typeof NODE_TYPES)[number];\n\nexport const SEMANTIC_LAYER_TYPES: NodeType[] = ['concept', 'note', 'chunk'];\nexport const EPISODE_LAYER_TYPES: NodeType[] = ['episode', 'document', 'section'];\nexport const ARCHIVE_LAYER_TYPES: NodeType[] = ['raw'];\n\n// ============================================================\n// SUBTYPES\n// ============================================================\n\nexport const CONCEPT_SUBTYPES = [\n  'fact',\n  'definition',\n  'relationship',\n  'preference',\n  'belief',\n  'procedure',\n  'entity',\n  'event',\n  'insight',\n] as const;\n\nexport type ConceptSubtype = (typeof CONCEPT_SUBTYPES)[number] | `custom:${string}`;\n\nexport const EPISODE_SUBTYPES = [\n  'lecture',\n  'meeting',\n  'conversation',\n  'note_session',\n  'document_read',\n  'thought',\n  'external_event',\n] as const;\n\nexport type EpisodeSubtype = (typeof EPISODE_SUBTYPES)[number] | `custom:${string}`;\n\nexport const RAW_SUBTYPES = [\n  'transcript',\n  'document',\n  'note',\n  'image',\n  'audio_recording',\n] as const;\n\nexport type RawSubtype = (typeof RAW_SUBTYPES)[number];\n\n// ============================================================\n// BLOCK TYPES\n// ============================================================\n\nexport const BLOCK_TYPES = [\n  'paragraph',\n  'heading',\n  'list',\n  'list_item',\n  'code',\n  'quote',\n  'callout',\n  'divider',\n  'table',\n  'image',\n] as const;\n\nexport type BlockType = (typeof BLOCK_TYPES)[number];\n\n// ============================================================\n// EDGE TYPES\n// ============================================================\n\nexport const EDGE_TYPES = [\n  'relates_to',\n  'part_of',\n  'mentioned_in',\n  'causes',\n  'precedes',\n  'contradicts',\n  'supersedes',\n  'derived_from',\n  'similar_to',\n] as const;\n\nexport type EdgeType = (typeof EDGE_TYPES)[number];\n\n// ============================================================\n// LIFECYCLE STATES\n// ============================================================\n\nexport const LIFECYCLE_STATES = [\n  'working',\n  'active',\n  'superseded',\n  'dormant',\n  'archived',\n] as const;\n\nexport type LifecycleState = (typeof LIFECYCLE_STATES)[number];\n\n// ============================================================\n// SOURCE TYPES\n// ============================================================\n\nexport const SOURCE_TYPES = [\n  'extraction',\n  'manual',\n  'inference',\n  'import',\n] as const;\n\nexport type SourceType = (typeof SOURCE_TYPES)[number];\n\n// ============================================================\n// CONTENT SOURCES\n// ============================================================\n\nexport const CONTENT_SOURCES = [\n  'import',\n  'user_note',\n  'chat_extraction',\n  'fact',\n  'document',\n  'transcript',\n] as const;\n\nexport type ContentSource = (typeof CONTENT_SOURCES)[number];\n\n// ============================================================\n// EDIT SYSTEM\n// ============================================================\n\nexport const EDIT_TARGET_METHODS = [\n  'block_id',\n  'heading',\n  'position',\n  'search',\n  'full',\n] as const;\n\nexport type EditTargetMethod = (typeof EDIT_TARGET_METHODS)[number];\n\nexport const EDIT_ACTIONS = ['replace', 'insert', 'append', 'delete'] as const;\n\nexport type EditAction = (typeof EDIT_ACTIONS)[number];\n\nexport const MODIFIERS = ['user', 'ai', 'system', 'sync'] as const;\n\nexport type Modifier = (typeof MODIFIERS)[number];\n\nexport const EDIT_HISTORY_RETENTION = {\n  maxEdits: 100,\n  maxAgeDays: 30,\n  undoWindowHours: 24,\n  pruneSchedule: 'daily',\n} as const;\n\n// ============================================================\n// TEMPORAL\n// ============================================================\n\nexport const TEMPORAL_GRANULARITIES = [\n  'minute',\n  'hour',\n  'day',\n  'week',\n  'month',\n  'year',\n] as const;\n\nexport type TemporalGranularity = (typeof TEMPORAL_GRANULARITIES)[number];\n\nexport const EVENT_TIME_SOURCES = ['explicit', 'inferred', 'user_stated'] as const;\n\nexport type EventTimeSource = (typeof EVENT_TIME_SOURCES)[number];\n\nexport const CONTENT_TIME_TYPES = ['historical', 'relative', 'approximate'] as const;\n\nexport type ContentTimeType = (typeof CONTENT_TIME_TYPES)[number];\n\n// ============================================================\n// PROCESSING PATHS\n// ============================================================\n\nexport const INPUT_TYPES = [\n  'DOCUMENT',\n  'TRANSCRIPT',\n  'CONVERSATION',\n  'NOTE',\n  'IMPORT',\n] as const;\n\nexport type InputType = (typeof INPUT_TYPES)[number];\n\nexport const INPUT_SIZES = ['tiny', 'small', 'medium', 'large', 'huge'] as const;\n\nexport type InputSize = (typeof INPUT_SIZES)[number];\n\nexport const PROCESSING_PATHS = [\n  'fast',\n  'standard',\n  'progressive',\n  'conversation',\n] as const;\n\nexport type ProcessingPath = (typeof PROCESSING_PATHS)[number];\n\nexport const SIZE_THRESHOLDS = {\n  tiny: { min: 0, max: 50 },\n  small: { min: 50, max: 500 },\n  medium: { min: 500, max: 5000 },\n  large: { min: 5000, max: 25000 },\n  huge: { min: 25000, max: Infinity },\n} as const;\n\n// ============================================================\n// BLOCK DECISION THRESHOLDS\n// ============================================================\n\nexport const BLOCK_LENGTH_THRESHOLD = 1000;\nexport const BLOCK_LIST_THRESHOLD = 3;\n\n// ============================================================\n// NEURAL DEFAULTS\n// ============================================================\n\nexport const NEURAL_DEFAULTS = {\n  stability: 0.5,\n  retrievability: 1.0,\n  accessCount: 0,\n} as const;\n\n// ============================================================\n// EXTRACTION DEPTH\n// ============================================================\n\nexport const EXTRACTION_DEPTHS = ['summary', 'section', 'full'] as const;\n\nexport type ExtractionDepth = (typeof EXTRACTION_DEPTHS)[number];\n\n// ============================================================\n// REGEX PATTERNS\n// ============================================================\n\nexport const HEADING_PATTERN = /^#{1,6}\\s/m;\nexport const LIST_ITEM_PATTERN = /^[-*]\\s/gm;\n","/**\n * @module @nous/core/blocks\n * @description Block structure for long-form content with stable IDs\n * @version 0.1.0\n * @spec Brainstorms/Specs/storm-011/spec/block-schema.ts\n *\n * Blocks enable:\n * - Semantic anchor editing (target by heading, block ID)\n * - Stable references during sync\n * - Structured content preservation\n */\n\nimport { z } from 'zod';\nimport { nanoid } from 'nanoid';\nimport {\n  NANOID_LENGTH,\n  BLOCK_ID_PREFIX,\n  BLOCK_TYPES,\n  BLOCK_LENGTH_THRESHOLD,\n  BLOCK_LIST_THRESHOLD,\n  HEADING_PATTERN,\n  LIST_ITEM_PATTERN,\n  type BlockType,\n  type ContentSource,\n} from '../constants';\n\n// ============================================================\n// ID GENERATION\n// ============================================================\n\n/**\n * Generates a globally unique block ID.\n * Format: \"b_\" + 12-character nanoid\n */\nexport function generateBlockId(): string {\n  return BLOCK_ID_PREFIX + nanoid(NANOID_LENGTH);\n}\n\n// ============================================================\n// BLOCK INTERFACE\n// ============================================================\n\n/**\n * A structural block within a node's content.\n */\nexport interface Block {\n  /** Globally unique block ID. Format: \"b_\" + nanoid(12) */\n  id: string;\n  /** Block type determines rendering and behavior */\n  type: BlockType;\n  /** The actual content of this block */\n  content: string;\n  /** Heading level (1-6). Only used for 'heading' type blocks. */\n  level?: number;\n  /** Child blocks for nested content. */\n  children?: Block[];\n  /** When this block was created (ISO 8601) */\n  created: string;\n  /** When this block was last modified (ISO 8601) */\n  modified: string;\n}\n\nexport const BlockSchema: z.ZodType<Block> = z.lazy(() =>\n  z.object({\n    id: z.string().regex(/^b_[a-zA-Z0-9_-]{12}$/),\n    type: z.enum(BLOCK_TYPES),\n    content: z.string(),\n    level: z.number().int().min(1).max(6).optional(),\n    children: z.array(BlockSchema).optional(),\n    created: z.string().datetime(),\n    modified: z.string().datetime(),\n  })\n);\n\n// ============================================================\n// BLOCK DECISION FUNCTIONS\n// ============================================================\n\n/**\n * Determines if content should use block structure.\n *\n * Rules (from storm-011 v4):\n * 1. Length > 1000 chars → YES\n * 2. Has markdown headings → YES\n * 3. Has 3+ list items → YES\n * 4. Source is 'import' or 'user_note' → YES\n * 5. Source is 'chat_extraction' or 'fact' → NO\n * 6. Default → NO\n */\nexport function shouldUseBlocks(content: string, source: ContentSource): boolean {\n  // Rule 1: Length threshold\n  if (content.length > BLOCK_LENGTH_THRESHOLD) {\n    return true;\n  }\n\n  // Rule 2: Has natural structure (headings)\n  if (hasHeadings(content)) {\n    return true;\n  }\n\n  // Rule 3: Has natural structure (multiple lists)\n  if (hasMultipleLists(content)) {\n    return true;\n  }\n\n  // Rule 4: Source types that always use blocks\n  if (source === 'import' || source === 'user_note') {\n    return true;\n  }\n\n  // Rule 5: Source types that never use blocks\n  if (source === 'chat_extraction' || source === 'fact') {\n    return false;\n  }\n\n  // Default: no blocks\n  return false;\n}\n\n/**\n * Checks if content contains markdown headings.\n */\nexport function hasHeadings(content: string): boolean {\n  return HEADING_PATTERN.test(content);\n}\n\n/**\n * Checks if content has multiple list items.\n */\nexport function hasMultipleLists(content: string): boolean {\n  const matches = content.match(LIST_ITEM_PATTERN) || [];\n  return matches.length >= BLOCK_LIST_THRESHOLD;\n}\n\n// ============================================================\n// BLOCK CREATION\n// ============================================================\n\n/**\n * Creates a new block with generated ID and timestamps.\n */\nexport function createBlock(\n  type: BlockType,\n  content: string,\n  options: { level?: number; children?: Block[] } = {}\n): Block {\n  const now = new Date().toISOString();\n  return {\n    id: generateBlockId(),\n    type,\n    content,\n    level: options.level,\n    children: options.children,\n    created: now,\n    modified: now,\n  };\n}\n\n// ============================================================\n// BLOCK PARSING\n// ============================================================\n\n/**\n * Parses markdown content into block structure.\n */\nexport function parseIntoBlocks(body: string): Block[] {\n  const blocks: Block[] = [];\n  const lines = body.split('\\n');\n\n  let currentParagraph: string[] = [];\n\n  const flushParagraph = (): void => {\n    if (currentParagraph.length > 0) {\n      const content = currentParagraph.join('\\n').trim();\n      if (content) {\n        blocks.push(createBlock('paragraph', content));\n      }\n      currentParagraph = [];\n    }\n  };\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    if (line === undefined) continue;\n\n    // Heading detection\n    const headingMatch = line.match(/^(#{1,6})\\s+(.+)$/);\n    if (headingMatch && headingMatch[1] && headingMatch[2]) {\n      flushParagraph();\n      blocks.push(\n        createBlock('heading', headingMatch[2], {\n          level: headingMatch[1].length,\n        })\n      );\n      continue;\n    }\n\n    // Code block detection\n    if (line.startsWith('```')) {\n      flushParagraph();\n      const codeLines: string[] = [];\n      i++; // Move past opening ```\n      while (i < lines.length) {\n        const codeLine = lines[i];\n        if (codeLine === undefined || codeLine.startsWith('```')) break;\n        codeLines.push(codeLine);\n        i++;\n      }\n      blocks.push(createBlock('code', codeLines.join('\\n')));\n      continue;\n    }\n\n    // Quote detection\n    if (line.startsWith('> ')) {\n      flushParagraph();\n      const quoteContent = line.slice(2);\n      blocks.push(createBlock('quote', quoteContent));\n      continue;\n    }\n\n    // List detection\n    const listMatch = line.match(/^[-*]\\s+(.+)$/);\n    if (listMatch && listMatch[1]) {\n      flushParagraph();\n\n      // Collect all consecutive list items\n      const listItems: Block[] = [];\n      while (i < lines.length) {\n        const currentLine = lines[i];\n        if (currentLine === undefined) break;\n        const itemMatch = currentLine.match(/^[-*]\\s+(.+)$/);\n        if (!itemMatch || !itemMatch[1]) break;\n        listItems.push(createBlock('list_item', itemMatch[1]));\n        i++;\n      }\n      i--; // Back up one since loop will increment\n\n      blocks.push(createBlock('list', '', { children: listItems }));\n      continue;\n    }\n\n    // Divider detection\n    if (line.match(/^[-*_]{3,}$/)) {\n      flushParagraph();\n      blocks.push(createBlock('divider', ''));\n      continue;\n    }\n\n    // Empty line ends paragraph\n    if (line.trim() === '') {\n      flushParagraph();\n      continue;\n    }\n\n    // Regular content → accumulate in paragraph\n    currentParagraph.push(line);\n  }\n\n  // Flush any remaining paragraph\n  flushParagraph();\n\n  return blocks;\n}\n\n// ============================================================\n// BODY DERIVATION\n// ============================================================\n\n/**\n * Derives markdown body from block structure.\n * This is the inverse of parseIntoBlocks.\n */\nexport function deriveBody(blocks: Block[]): string {\n  return blocks.map((block) => blockToMarkdown(block)).join('\\n\\n');\n}\n\n/**\n * Converts a single block to markdown.\n */\nfunction blockToMarkdown(block: Block): string {\n  switch (block.type) {\n    case 'heading':\n      return '#'.repeat(block.level || 1) + ' ' + block.content;\n\n    case 'paragraph':\n      return block.content;\n\n    case 'list':\n      return (block.children || []).map((child) => '- ' + child.content).join('\\n');\n\n    case 'list_item':\n      return '- ' + block.content;\n\n    case 'quote':\n      return '> ' + block.content;\n\n    case 'code':\n      return '```\\n' + block.content + '\\n```';\n\n    case 'callout':\n      return '> [!note]\\n> ' + block.content;\n\n    case 'divider':\n      return '---';\n\n    case 'table':\n      return block.content;\n\n    case 'image':\n      return block.content;\n\n    default:\n      return block.content;\n  }\n}\n\n// ============================================================\n// BLOCK UTILITIES\n// ============================================================\n\n/**\n * Finds a block by ID within a block tree.\n */\nexport function findBlockById(blocks: Block[], blockId: string): Block | undefined {\n  for (const block of blocks) {\n    if (block.id === blockId) {\n      return block;\n    }\n    if (block.children) {\n      const found = findBlockById(block.children, blockId);\n      if (found) return found;\n    }\n  }\n  return undefined;\n}\n\n/**\n * Finds a block by heading text.\n */\nexport function findBlockByHeading(\n  blocks: Block[],\n  heading: string,\n  level?: number\n): Block | undefined {\n  for (const block of blocks) {\n    if (block.type === 'heading') {\n      const matchesText = block.content.toLowerCase() === heading.toLowerCase();\n      const matchesLevel = level === undefined || block.level === level;\n      if (matchesText && matchesLevel) {\n        return block;\n      }\n    }\n    if (block.children) {\n      const found = findBlockByHeading(block.children, heading, level);\n      if (found) return found;\n    }\n  }\n  return undefined;\n}\n\n/**\n * Gets all block IDs in a block tree.\n */\nexport function getAllBlockIds(blocks: Block[]): string[] {\n  const ids: string[] = [];\n  for (const block of blocks) {\n    ids.push(block.id);\n    if (block.children) {\n      ids.push(...getAllBlockIds(block.children));\n    }\n  }\n  return ids;\n}\n\n/**\n * Updates a block's modified timestamp.\n */\nexport function touchBlock(block: Block): Block {\n  return {\n    ...block,\n    modified: new Date().toISOString(),\n  };\n}\n\n/**\n * Counts total number of blocks including nested children.\n */\nexport function countBlocks(blocks: Block[]): number {\n  let count = 0;\n  for (const block of blocks) {\n    count++;\n    if (block.children) {\n      count += countBlocks(block.children);\n    }\n  }\n  return count;\n}\n\n// ============================================================\n// RE-EXPORTS\n// ============================================================\n\nexport type { BlockType, ContentSource };\n"]}