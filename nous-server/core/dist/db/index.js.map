{"version":3,"sources":["../../src/security/constants.ts","../../src/db/config.ts","../../src/db/schema.ts","../../src/db/adapter.ts","../../src/db/turso-adapter.ts"],"names":["z"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @module @nous/core/security\n * @description Constants for Nous Security Layer (NSL)\n * @version 1.0.0\n * @spec Specs/Phase-6-Technical-Services/storm-022\n * @storm Brainstorms/Infrastructure/storm-022-security-auth\n *\n * All security constants, enums, crypto parameters, thresholds, and configuration\n * defaults for the two-tier privacy model. These values come from storm-022 v2\n * revision and should not be changed without updating the brainstorm.\n *\n * @see {@link Specs/Phase-6-Technical-Services/storm-022/Index} - Spec overview\n * @see {@link Brainstorms/Infrastructure/storm-022-security-auth/_SESSION} - Brainstorm\n */\n\nimport { z } from 'zod';\n\n// ============================================================\n// PRIVACY TIERS\n// ============================================================\n\n/**\n * Two-tier privacy model.\n *\n * - **standard:** Server-managed encryption (Turso AES-256 at-rest), full cloud search, seamless LLM\n * - **private:** Full E2E encryption (AES-256-GCM client-side), client-side HNSW search, explicit LLM consent\n *\n * @see storm-022 v1 revision Section 2 - Simplified from 3 tiers to 2\n */\nexport const PRIVACY_TIERS = ['standard', 'private'] as const;\n\nexport type PrivacyTier = (typeof PRIVACY_TIERS)[number];\n\nexport const PrivacyTierSchema = z.enum(PRIVACY_TIERS);\n\n/**\n * Type guard for PrivacyTier.\n */\nexport function isPrivacyTier(value: unknown): value is PrivacyTier {\n  return PRIVACY_TIERS.includes(value as PrivacyTier);\n}\n\n// ============================================================\n// AUTH PROVIDERS\n// ============================================================\n\n/**\n * Supported authentication providers.\n * Clerk recommended for DX, extensible for future providers.\n *\n * @see storm-022 research.md - Auth provider comparison\n */\nexport const AUTH_PROVIDERS = ['clerk'] as const;\n\nexport type AuthProvider = (typeof AUTH_PROVIDERS)[number];\n\nexport const AuthProviderSchema = z.enum(AUTH_PROVIDERS);\n\n/**\n * Supported authentication methods.\n * Sign in with Apple is REQUIRED for iOS if offering social login.\n *\n * @see storm-022 original-prompt.md - User requirements\n */\nexport const AUTH_METHODS = ['apple', 'google', 'email_password'] as const;\n\nexport type AuthMethod = (typeof AUTH_METHODS)[number];\n\nexport const AuthMethodSchema = z.enum(AUTH_METHODS);\n\n// ============================================================\n// PLATFORMS\n// ============================================================\n\n/**\n * Supported platforms.\n * iOS/Android use native Clerk SDKs.\n * macOS/Windows use system browser OAuth with deep links (Tauri).\n *\n * @see storm-022 v1 revision Section 1 - Platform-specific implementation\n */\nexport const PLATFORMS = ['ios', 'android', 'macos', 'windows'] as const;\n\nexport type Platform = (typeof PLATFORMS)[number];\n\nexport const PlatformSchema = z.enum(PLATFORMS);\n\n/**\n * Type guard for Platform.\n */\nexport function isPlatform(value: unknown): value is Platform {\n  return PLATFORMS.includes(value as Platform);\n}\n\n// ============================================================\n// OFFLINE STATES\n// ============================================================\n\n/**\n * Offline authentication states with graceful degradation.\n *\n * - **online:** Full functionality\n * - **short_offline:** <24h, JWT valid, full functionality\n * - **medium_offline:** <7d, JWT expired, read-only + queued writes\n * - **long_offline:** >7d, refresh expired, local only\n * - **reauth_required:** Must reconnect to continue\n *\n * @see storm-022 v1 revision Section 1 - Token Management & Offline States\n */\nexport const OFFLINE_STATES = [\n  'online',\n  'short_offline',\n  'medium_offline',\n  'long_offline',\n  'reauth_required',\n] as const;\n\nexport type OfflineState = (typeof OFFLINE_STATES)[number];\n\nexport const OfflineStateSchema = z.enum(OFFLINE_STATES);\n\n/**\n * Type guard for OfflineState.\n */\nexport function isOfflineState(value: unknown): value is OfflineState {\n  return OFFLINE_STATES.includes(value as OfflineState);\n}\n\n/**\n * Offline state transition thresholds (in hours).\n *\n * @see storm-022 v1 revision Section 1 - updateOfflineState()\n */\nexport const OFFLINE_THRESHOLDS = {\n  /** <24h since last online: JWT still valid, full functionality */\n  short_offline: 24,\n  /** <7d (168h) since last online: JWT expired, read-only + queued writes */\n  medium_offline: 168,\n  /** >7d: refresh token expired, local data only */\n  long_offline: Infinity,\n} as const;\n\n// ============================================================\n// CONSENT SCOPES\n// ============================================================\n\n/**\n * LLM consent scope options for Private tier users.\n *\n * - **per_message:** Every LLM query shows consent dialog (most secure)\n * - **per_conversation:** First query shows dialog; subsequent auto-approved (default)\n * - **time_based:** Consent valid for chosen duration (1h, 24h, 7d)\n * - **topic_based:** \"Remember for similar questions\" using embedding similarity\n *\n * @see storm-022 v2 Section 10.2 - Per-Message vs Per-Session Consent\n */\nexport const CONSENT_SCOPES = [\n  'per_message',\n  'per_conversation',\n  'time_based',\n  'topic_based',\n] as const;\n\nexport type ConsentScope = (typeof CONSENT_SCOPES)[number];\n\nexport const ConsentScopeSchema = z.enum(CONSENT_SCOPES);\n\n/**\n * Type guard for ConsentScope.\n */\nexport function isConsentScope(value: unknown): value is ConsentScope {\n  return CONSENT_SCOPES.includes(value as ConsentScope);\n}\n\n/**\n * Default consent scope for new Private tier users.\n * Per-conversation balances security and UX.\n *\n * @see storm-022 _SESSION.md - Decision: per-session consent default\n */\nexport const DEFAULT_CONSENT_SCOPE: ConsentScope = 'per_conversation';\n\n/**\n * Conversation idle timeout before consent resets (minutes).\n * After 30 min idle, per-conversation consent expires.\n *\n * @see storm-022 v2 Section 10.2 - \"Conversation\" = continuous session, resets after 30 min idle\n */\nexport const CONVERSATION_TIMEOUT_MINUTES = 30;\n\n/**\n * Cosine similarity threshold for topic-based consent matching.\n * Queries with >0.85 similarity to remembered topic are auto-approved.\n *\n * @see storm-022 v2 Section 10.2 - Similarity threshold: 0.85 cosine similarity\n */\nexport const TOPIC_SIMILARITY_THRESHOLD = 0.85;\n\n/**\n * Time-based consent duration options.\n *\n * @see storm-022 v2 Section 10.2 - Time-Based (Convenience)\n */\nexport const CONSENT_DURATIONS = ['1h', '24h', '7d'] as const;\n\nexport type ConsentDuration = (typeof CONSENT_DURATIONS)[number];\n\nexport const ConsentDurationSchema = z.enum(CONSENT_DURATIONS);\n\n// ============================================================\n// CONSENT REVOCATION SCOPES\n// ============================================================\n\n/**\n * Consent revocation granularity options.\n *\n * @see storm-022 v2 Section 10.5 - Consent Revocation Flow\n */\nexport const CONSENT_REVOCATION_SCOPES = [\n  'this_conversation',\n  'all_active',\n  'everything',\n] as const;\n\nexport type ConsentRevocationScope = (typeof CONSENT_REVOCATION_SCOPES)[number];\n\nexport const ConsentRevocationScopeSchema = z.enum(CONSENT_REVOCATION_SCOPES);\n\n// ============================================================\n// ENCRYPTION CONSTANTS\n// ============================================================\n\n/**\n * Encryption algorithm for all E2E operations.\n * AES-256-GCM provides authenticated encryption with associated data.\n *\n * @see storm-022 v1 revision Section 2 - E2E Encryption Design\n */\nexport const ENCRYPTION_ALGORITHM = 'AES-256-GCM';\n\n/**\n * Key derivation function used throughout.\n *\n * @see storm-022 v1 revision Section 3 - Key Hierarchy\n */\nexport const KEY_DERIVATION_FUNCTION = 'HKDF-SHA256';\n\n/**\n * Master key length in bits. Standard for AES-256.\n */\nexport const MASTER_KEY_LENGTH_BITS = 256;\n\n/**\n * AES-GCM nonce length in bytes (96 bits).\n * CRITICAL: Every encryption MUST use a unique nonce. Nonce reuse with same key\n * is catastrophic for AES-GCM security.\n */\nexport const NONCE_LENGTH_BYTES = 12;\n\n/**\n * Derived key purpose strings for HKDF.\n * Each derived key uses a unique purpose string to produce\n * cryptographically independent keys from the same master key.\n *\n * @see storm-022 v1 revision Section 3 - HKDF with purpose strings\n */\nexport const KEY_PURPOSES = ['content', 'embedding', 'metadata'] as const;\n\nexport type KeyPurpose = (typeof KEY_PURPOSES)[number];\n\nexport const KeyPurposeSchema = z.enum(KEY_PURPOSES);\n\n/**\n * HKDF info strings for key derivation.\n * Format: 'nous-{purpose}'\n *\n * @see storm-022 v1 revision Section 3 - HKDF(\"content\"), HKDF(\"embedding\"), HKDF(\"metadata\")\n */\nexport const DERIVATION_INFO_STRINGS: Record<KeyPurpose, string> = {\n  content: 'nous-content',\n  embedding: 'nous-embedding',\n  metadata: 'nous-metadata',\n} as const;\n\n// ============================================================\n// KEY ROTATION CONSTANTS\n// ============================================================\n\n/**\n * Number of nodes processed per re-encryption batch.\n *\n * @see storm-022 v2 Section 9.7 - Batch Re-encryption Strategy\n */\nexport const ROTATION_BATCH_SIZE = 100;\n\n/**\n * Pause between batches to prevent UI jank (milliseconds).\n *\n * @see storm-022 v2 Section 9.7 - RotationConfig\n */\nexport const ROTATION_PAUSE_BETWEEN_BATCHES_MS = 500;\n\n/**\n * Maximum batches per minute (rate limit).\n *\n * @see storm-022 v2 Section 9.7 - RotationConfig\n */\nexport const ROTATION_MAX_BATCHES_PER_MINUTE = 60;\n\n/**\n * Minimum battery level to continue rotation (percentage).\n * Rotation pauses if battery drops below this threshold.\n *\n * @see storm-022 v2 Section 9.7 - RotationConfig\n */\nexport const ROTATION_MIN_BATTERY_LEVEL = 20;\n\n/**\n * Days to retain deprecated key version after rotation.\n * Handles devices that haven't synced yet.\n *\n * @see storm-022 v2 Section 9.3 - \"status: 'deprecated' for old key (kept 30 days for sync lag)\"\n */\nexport const DEPRECATED_KEY_RETENTION_DAYS = 30;\n\n/**\n * Percentage of nodes to sample for post-rotation verification.\n *\n * @see storm-022 v2 Section 9.3 - \"Sample 5% of nodes\"\n */\nexport const ROTATION_VERIFICATION_SAMPLE_PERCENT = 5;\n\n/**\n * Key version lifecycle statuses.\n *\n * @see storm-022 v2 Section 9.2 - KeyVersion interface\n */\nexport const KEY_VERSION_STATUSES = ['active', 'rotating', 'deprecated', 'expired'] as const;\n\nexport type KeyVersionStatus = (typeof KEY_VERSION_STATUSES)[number];\n\nexport const KeyVersionStatusSchema = z.enum(KEY_VERSION_STATUSES);\n\n/**\n * Type guard for KeyVersionStatus.\n */\nexport function isKeyVersionStatus(value: unknown): value is KeyVersionStatus {\n  return KEY_VERSION_STATUSES.includes(value as KeyVersionStatus);\n}\n\n/**\n * Key rotation triggers.\n *\n * @see storm-022 v2 Section 9.1 - When Key Rotation Occurs\n */\nexport const KEY_ROTATION_TRIGGERS = [\n  'passkey_change',\n  'scheduled',\n  'security_incident',\n  'recovery_used',\n] as const;\n\nexport type KeyRotationTrigger = (typeof KEY_ROTATION_TRIGGERS)[number];\n\nexport const KeyRotationTriggerSchema = z.enum(KEY_ROTATION_TRIGGERS);\n\n/**\n * Scheduled rotation interval in months.\n *\n * @see storm-022 v2 Section 9.1 - \"Scheduled rotation: Every 12 months\"\n */\nexport const SCHEDULED_ROTATION_MONTHS = 12;\n\n/**\n * Rotation re-encryption timing estimates (throttled, Wi-Fi + charging).\n *\n * @see storm-022 v2 Section 9.3 - Timing Estimates table\n */\nexport const ROTATION_TIMING_ESTIMATES = {\n  '1k': { reencrypt_seconds: 30, background_minutes: 2 },\n  '10k': { reencrypt_seconds: 300, background_minutes: 15 },\n  '50k': { reencrypt_seconds: 1500, background_minutes: 60 },\n} as const;\n\n// ============================================================\n// ROTATION PHASES\n// ============================================================\n\n/**\n * Phases of the key rotation process.\n *\n * @see storm-022 v2 Section 9.3 - 3-phase rotation flow\n */\nexport const ROTATION_PHASES = ['generating', 'reencrypting', 'verifying', 'completing'] as const;\n\nexport type RotationPhase = (typeof ROTATION_PHASES)[number];\n\nexport const RotationPhaseSchema = z.enum(ROTATION_PHASES);\n\n// ============================================================\n// ROTATION EVENTS\n// ============================================================\n\n/**\n * Rotation event types for UI updates.\n *\n * @see storm-022 v2 Section 9.4 - Migration UX Flow\n */\nexport const ROTATION_EVENT_TYPES = [\n  'rotation:started',\n  'rotation:progress',\n  'rotation:paused',\n  'rotation:resumed',\n  'rotation:completed',\n  'rotation:failed',\n] as const;\n\nexport type RotationEventType = (typeof ROTATION_EVENT_TYPES)[number];\n\nexport const RotationEventTypeSchema = z.enum(ROTATION_EVENT_TYPES);\n\n// ============================================================\n// RECOVERY CONSTANTS\n// ============================================================\n\n/**\n * BIP39 mnemonic word count for recovery code.\n *\n * @see storm-022 v1 revision Section 3 - \"24-word BIP39 mnemonic\"\n */\nexport const RECOVERY_WORD_COUNT = 24;\n\n/**\n * Number of random words user must enter during forced verification.\n *\n * @see storm-022 v1 revision Section 3 - \"Enter words 3, 8, and 17\"\n */\nexport const RECOVERY_VERIFICATION_WORD_COUNT = 3;\n\n/**\n * Maximum verification attempts before requiring code regeneration.\n */\nexport const RECOVERY_VERIFICATION_ATTEMPT_LIMIT = 3;\n\n/**\n * Grace period duration in days.\n * During this time, email recovery is available as a fallback.\n * After expiry, true E2E promise is honored (no backdoor).\n *\n * @see storm-022 v1 revision Section 3 - \"7-DAY GRACE PERIOD\"\n */\nexport const GRACE_PERIOD_DAYS = 7;\n\n/**\n * Recovery reminder schedule (days after Private tier setup).\n *\n * @see storm-022 v1 revision Section 3 - Periodic Reminders\n */\nexport const RECOVERY_REMINDER_DAYS = [30, 180] as const;\n\n/**\n * Recovery methods available to users.\n *\n * @see storm-022 v1 revision Section 3 - Recovery Options\n */\nexport const RECOVERY_METHODS = [\n  'multi_device',\n  'recovery_code',\n  'grace_period',\n] as const;\n\nexport type RecoveryMethod = (typeof RECOVERY_METHODS)[number];\n\nexport const RecoveryMethodSchema = z.enum(RECOVERY_METHODS);\n\n/**\n * Recovery reminder types.\n */\nexport const RECOVERY_REMINDER_TYPES = ['initial', 'periodic', 'new_device'] as const;\n\nexport type RecoveryReminderType = (typeof RECOVERY_REMINDER_TYPES)[number];\n\nexport const RecoveryReminderTypeSchema = z.enum(RECOVERY_REMINDER_TYPES);\n\n// ============================================================\n// TOKEN CONFIGURATION\n// ============================================================\n\n/**\n * JWT access token lifetime in minutes.\n *\n * @see storm-022 v1 revision Section 1 - \"Short-lived (15 min)\"\n */\nexport const ACCESS_TOKEN_EXPIRY_MINUTES = 15;\n\n/**\n * Refresh token lifetime in days.\n *\n * @see storm-022 v1 revision Section 1 - \"Long-lived (30 days)\"\n */\nexport const REFRESH_TOKEN_EXPIRY_DAYS = 30;\n\n// ============================================================\n// BYOK RATE LIMITING\n// ============================================================\n\n/**\n * Maximum BYOK key decryption attempts per minute.\n * Prevents brute force attacks on encrypted API keys.\n *\n * @see storm-022 v1 revision Section 6 - \"Max 5 key decryptions per minute\"\n */\nexport const BYOK_MAX_DECRYPTIONS_PER_MINUTE = 5;\n\n/**\n * Number of BYOK decryption failures before lockout.\n */\nexport const BYOK_LOCKOUT_AFTER_FAILURES = 10;\n\n/**\n * BYOK lockout duration in minutes after exceeding failure limit.\n */\nexport const BYOK_LOCKOUT_DURATION_MINUTES = 30;\n\n// ============================================================\n// CLIENT-SIDE SEARCH LIMITS (Private tier)\n// ============================================================\n\n/**\n * Maximum recommended node counts for Private tier client-side search.\n *\n * @see storm-022 v1 revision Section 2 - \"Private tier practical limit ~50K nodes on mobile\"\n */\nexport const PRIVATE_TIER_NODE_LIMITS = {\n  mobile: 50_000,\n  desktop: 100_000,\n} as const;\n\n/**\n * Client-side search performance estimates.\n *\n * @see storm-022 v1 revision Section 2 - Performance Limits table\n */\nexport const CLIENT_SEARCH_PERFORMANCE = {\n  /** Time to decrypt per 1K nodes (milliseconds) */\n  decrypt_time_ms_per_1k: 100,\n  /** Time to build HNSW index per 1K nodes (milliseconds) */\n  index_build_time_ms_per_1k: 200,\n  /** Search latency by node count (milliseconds) */\n  search_latency_ms: {\n    '10k': 20,\n    '50k': 40,\n    '100k': 60,\n  },\n  /** Memory usage per 10K nodes (megabytes) */\n  memory_mb_per_10k: 130,\n} as const;\n\n// ============================================================\n// AUTH SECURITY DEFAULTS\n// ============================================================\n\n/**\n * Brute force lockout threshold (login attempts).\n *\n * @see storm-022 v1 revision Section 1 - Security Measures via Clerk\n */\nexport const BRUTE_FORCE_LOCKOUT_ATTEMPTS = 5;\n\n/**\n * Brute force lockout duration (minutes).\n */\nexport const BRUTE_FORCE_LOCKOUT_MINUTES = 15;\n\n/**\n * CAPTCHA trigger threshold (failed attempts).\n */\nexport const CAPTCHA_AFTER_FAILURES = 3;\n\n// ============================================================\n// EXPORT COMPLIANCE\n// ============================================================\n\n/**\n * Export Control Classification Number for Private tier encryption.\n *\n * @see storm-022 v1 revision Section 7 - \"Self-classification under ECCN 5D992\"\n */\nexport const ECCN_CLASSIFICATION = '5D992';\n\n/**\n * Export compliance status levels.\n *\n * @see storm-022 v1 revision Section 7 - Export Compliance\n */\nexport const EXPORT_COMPLIANCE_STATUSES = [\n  'exempt',\n  'requires_documentation',\n  'excluded',\n] as const;\n\nexport type ExportComplianceStatus = (typeof EXPORT_COMPLIANCE_STATUSES)[number];\n\nexport const ExportComplianceStatusSchema = z.enum(EXPORT_COMPLIANCE_STATUSES);\n\n// ============================================================\n// DESKTOP AUTH FLOW STEPS\n// ============================================================\n\n/**\n * Desktop (Tauri) auth flow steps.\n *\n * @see storm-022 v1 revision Section 1 - Desktop Auth Flow\n */\nexport const DESKTOP_AUTH_STEPS = [\n  'idle',\n  'browser_opened',\n  'waiting_callback',\n  'processing_token',\n  'complete',\n  'error',\n] as const;\n\nexport type DesktopAuthStep = (typeof DESKTOP_AUTH_STEPS)[number];\n\nexport const DesktopAuthStepSchema = z.enum(DESKTOP_AUTH_STEPS);\n\n// ============================================================\n// TIER MIGRATION STATUSES\n// ============================================================\n\n/**\n * Tier migration process statuses.\n *\n * @see storm-022 v1 revision Section 4 - Tier Migration\n */\nexport const TIER_MIGRATION_STATUSES = [\n  'pending',\n  'key_setup',\n  'migrating',\n  'verifying',\n  'complete',\n  'failed',\n] as const;\n\nexport type TierMigrationStatus = (typeof TIER_MIGRATION_STATUSES)[number];\n\nexport const TierMigrationStatusSchema = z.enum(TIER_MIGRATION_STATUSES);\n\n/**\n * Tier migration rate: milliseconds per 1K nodes.\n * ~1 minute per 1K nodes.\n *\n * @see storm-022 v1 revision Section 4 - \"Duration: ~1 minute per 1K nodes\"\n */\nexport const MIGRATION_RATE_MS_PER_1K_NODES = 60_000;\n\n// ============================================================\n// CONSENT EVENT TYPES\n// ============================================================\n\n/**\n * Consent event types for logging and analytics.\n *\n * @see storm-022 v2 Section 10 - LLM Consent UX\n */\nexport const CONSENT_EVENT_TYPES = [\n  'consent:requested',\n  'consent:granted',\n  'consent:declined',\n  'consent:revoked',\n  'consent:expired',\n] as const;\n\nexport type ConsentEventType = (typeof CONSENT_EVENT_TYPES)[number];\n\nexport const ConsentEventTypeSchema = z.enum(CONSENT_EVENT_TYPES);\n\n// ============================================================\n// PASSKEY PLATFORMS\n// ============================================================\n\n/**\n * Passkey sync platforms (for multi-device key management).\n *\n * @see storm-022 v1 revision Section 3 - Key Hierarchy\n */\nexport const PASSKEY_PLATFORMS = ['apple', 'google', 'microsoft'] as const;\n\nexport type PasskeyPlatform = (typeof PASSKEY_PLATFORMS)[number];\n\nexport const PasskeyPlatformSchema = z.enum(PASSKEY_PLATFORMS);\n\n/**\n * Passkey sync mechanisms by platform.\n */\nexport const PASSKEY_SYNC_MECHANISMS: Record<PasskeyPlatform, string> = {\n  apple: 'icloud_keychain',\n  google: 'google_password_manager',\n  microsoft: 'microsoft_entra',\n} as const;\n\n// ============================================================\n// RECOVERY SETUP STEPS\n// ============================================================\n\n/**\n * Steps in the recovery code setup flow.\n *\n * @see storm-022 v1 revision Section 3 - Forced Verification setup flow\n */\nexport const RECOVERY_SETUP_STEPS = [\n  'generating',\n  'displaying',\n  'verifying',\n  'complete',\n] as const;\n\nexport type RecoverySetupStep = (typeof RECOVERY_SETUP_STEPS)[number];\n\nexport const RecoverySetupStepSchema = z.enum(RECOVERY_SETUP_STEPS);\n\n// ============================================================\n// API KEY TYPES\n// ============================================================\n\n/**\n * API key ownership types.\n *\n * @see storm-022 v1 revision Section 6 - API Key Security\n */\nexport const API_KEY_TYPES = ['platform', 'byok'] as const;\n\nexport type ApiKeyType = (typeof API_KEY_TYPES)[number];\n\nexport const ApiKeyTypeSchema = z.enum(API_KEY_TYPES);\n\n/**\n * API call flow modes.\n *\n * - **proxied:** Platform keys - calls go through Nous API proxy\n * - **direct:** BYOK - calls go directly from client to LLM provider\n *\n * @see storm-022 v1 revision Section 6 - API Call Flow diagrams\n */\nexport const API_CALL_FLOWS = ['proxied', 'direct'] as const;\n\nexport type ApiCallFlow = (typeof API_CALL_FLOWS)[number];\n\nexport const ApiCallFlowSchema = z.enum(API_CALL_FLOWS);\n\n// ============================================================\n// BYOK ENCRYPTION METHODS\n// ============================================================\n\n/**\n * BYOK key encryption methods by tier.\n *\n * - **server_side:** Standard tier - Nous API decrypts\n * - **user_key:** Private tier - only user's device can decrypt\n *\n * @see storm-022 v1 revision Section 6 - BYOK Key Storage\n */\nexport const BYOK_ENCRYPTION_METHODS = ['server_side', 'user_key'] as const;\n\nexport type BYOKEncryptionMethod = (typeof BYOK_ENCRYPTION_METHODS)[number];\n\nexport const BYOKEncryptionMethodSchema = z.enum(BYOK_ENCRYPTION_METHODS);\n\n// ============================================================\n// MFA OPTIONS\n// ============================================================\n\n/**\n * Multi-factor authentication options (via Clerk).\n *\n * @see storm-022 v1 revision Section 1 - Security Measures\n */\nexport const MFA_OPTIONS = ['totp', 'sms', 'passkey'] as const;\n\nexport type MfaOption = (typeof MFA_OPTIONS)[number];\n\nexport const MfaOptionSchema = z.enum(MFA_OPTIONS);\n\n// ============================================================\n// SIGN-IN METHOD IMPLEMENTATIONS\n// ============================================================\n\n/**\n * Sign-in method implementation approaches by platform.\n *\n * @see storm-022 v1 revision Section 1 - Platform-Specific Implementation table\n */\nexport const SIGN_IN_IMPLEMENTATIONS = ['native', 'rest_api', 'oauth', 'clerk_ui', 'clerk_web'] as const;\n\nexport type SignInImplementation = (typeof SIGN_IN_IMPLEMENTATIONS)[number];\n\nexport const SignInImplementationSchema = z.enum(SIGN_IN_IMPLEMENTATIONS);\n\n// ============================================================\n// DEEP LINK SCHEME\n// ============================================================\n\n/**\n * Deep link scheme for desktop (Tauri) OAuth callback.\n *\n * @see storm-022 v1 revision Section 1 - \"nous://auth/callback?token=...\"\n */\nexport const DEEP_LINK_SCHEME = 'nous';\n\n/**\n * OAuth callback path.\n */\nexport const AUTH_CALLBACK_PATH = '/auth/callback';\n\n// ============================================================\n// OFFLINE FUNCTIONALITY LEVELS\n// ============================================================\n\n/**\n * Functionality levels available in offline states.\n *\n * @see storm-022 v1 revision Section 1 - Offline States table\n */\nexport const OFFLINE_FUNCTIONALITY_LEVELS = [\n  'full',\n  'read_write_queued',\n  'read_only',\n  'local_only',\n] as const;\n\nexport type OfflineFunctionality = (typeof OFFLINE_FUNCTIONALITY_LEVELS)[number];\n\nexport const OfflineFunctionalitySchema = z.enum(OFFLINE_FUNCTIONALITY_LEVELS);\n\n// ============================================================\n// OFFLINE SYNC BEHAVIORS\n// ============================================================\n\n/**\n * Sync behaviors for each offline state.\n */\nexport const OFFLINE_SYNC_BEHAVIORS = [\n  'realtime',\n  'queued',\n  'paused',\n  'none',\n] as const;\n\nexport type OfflineSyncBehavior = (typeof OFFLINE_SYNC_BEHAVIORS)[number];\n\nexport const OfflineSyncBehaviorSchema = z.enum(OFFLINE_SYNC_BEHAVIORS);\n\n// ============================================================\n// QUEUEABLE TABLES\n// ============================================================\n\n/**\n * Tables that can have queued offline operations.\n */\nexport const QUEUEABLE_TABLES = ['nodes', 'edges', 'episodes'] as const;\n\nexport type QueueableTable = (typeof QUEUEABLE_TABLES)[number];\n\n/**\n * Operation types for the offline sync queue.\n */\nexport const QUEUE_OPERATION_TYPES = ['create', 'update', 'delete'] as const;\n\nexport type QueueOperationType = (typeof QUEUE_OPERATION_TYPES)[number];\n\n// ============================================================\n// DECLINE ACTIONS (Consent)\n// ============================================================\n\n/**\n * Actions available to the user after declining LLM memory access.\n *\n * @see storm-022 v2 Section 10.6 - Graceful Degradation Rules\n */\nexport const DECLINE_ACTIONS = [\n  'general_questions',\n  'writing_assistance',\n  'brainstorming',\n  'allow_this_question',\n  'end_conversation',\n] as const;\n\nexport type DeclineAction = (typeof DECLINE_ACTIONS)[number];\n\n// ============================================================\n// LLM PROVIDERS (API Key Management)\n// ============================================================\n\n/**\n * Supported LLM providers for API key management.\n *\n * @see storm-022 v1 revision Section 6 - API Key Security\n * @see storm-015 - LLM Integration provider pool\n */\nexport const LLM_PROVIDERS = ['openai', 'anthropic', 'google'] as const;\n\nexport type LLMProvider = (typeof LLM_PROVIDERS)[number];\n\nexport const LLMProviderSchema = z.enum(LLM_PROVIDERS);\n\n// ============================================================\n// RE-ENCRYPTION PRIORITY\n// ============================================================\n\n/**\n * Priority ordering for re-encryption during key rotation.\n *\n * @see storm-022 v2 Section 9.7 - Priority Ordering\n */\nexport const REENCRYPTION_PRIORITY_ORDER = [\n  'recently_accessed',\n  'frequently_accessed',\n  'oldest_first',\n] as const;\n\nexport type ReencryptionPriority = (typeof REENCRYPTION_PRIORITY_ORDER)[number];\n\n","/**\n * @module @nous/core/db/config\n * @description Database and sync configuration types\n * @version 1.0.0\n * @spec Brainstorms/Specs/storm-017\n * @storm Brainstorms/Infrastructure/storm-017-infrastructure-architecture\n *\n * Implements configuration for Turso/libSQL database with embedded replica pattern.\n */\n\nimport { z } from 'zod';\n\n// Re-use canonical privacy tier from security module (avoids duplicate export in barrel)\nimport { PRIVACY_TIERS, type PrivacyTier } from '../security/constants';\n\n// ============================================================\n// DATABASE DEFAULTS\n// ============================================================\n\n/**\n * Default database configuration values.\n */\nexport const DB_DEFAULTS = {\n  /** OpenAI embedding dimensions */\n  vectorDimensions: 1536,\n  /** DiskANN index parameter */\n  maxNeighbors: 50,\n  /** Default sync batch size */\n  syncBatchSize: 100,\n  /** Current schema version */\n  schemaVersion: 2,\n  /** Default sync interval in milliseconds */\n  syncIntervalMs: 60_000,\n  /** Default connection timeout */\n  connectionTimeoutMs: 10_000,\n  /** Max retry attempts */\n  maxRetries: 3,\n  /** Base retry delay */\n  retryDelayMs: 1000,\n} as const;\n\n// ============================================================\n// DATABASE MODE\n// ============================================================\n\n/**\n * Database operation modes.\n * - local: SQLite file on device only\n * - cloud: Turso cloud database only\n * - replica: Embedded replica (local + cloud sync)\n */\nexport const DATABASE_MODES = ['local', 'cloud', 'replica'] as const;\nexport type DatabaseMode = (typeof DATABASE_MODES)[number];\n\n// ============================================================\n// SYNC MODE\n// ============================================================\n\n/**\n * Sync behavior modes.\n * - auto: Automatic sync on schedule and changes\n * - manual: Sync only when explicitly triggered\n * - disabled: No sync (local-only)\n */\nexport const SYNC_MODES = ['auto', 'manual', 'disabled'] as const;\nexport type SyncMode = (typeof SYNC_MODES)[number];\n\n// ============================================================\n// PRIVACY TIER\n// ============================================================\n\n// PRIVACY_TIERS and PrivacyTier are imported + re-exported from security/constants above\n\n// ============================================================\n// TURSO CONFIG\n// ============================================================\n\n/**\n * Turso database connection configuration.\n */\nexport interface TursoConfig {\n  /** Database URL (libsql:// or file://) */\n  url: string;\n  /** Authentication token for Turso cloud */\n  authToken?: string;\n  /** Sync URL for embedded replica mode */\n  syncUrl?: string;\n  /** Sync interval in milliseconds */\n  syncIntervalMs?: number;\n  /** Enable encryption at rest */\n  encryptionKey?: string;\n}\n\nexport const TursoConfigSchema = z.object({\n  url: z.string().min(1),\n  authToken: z.string().optional(),\n  syncUrl: z.string().url().optional(),\n  syncIntervalMs: z.number().int().positive().optional(),\n  encryptionKey: z.string().optional(),\n});\n\n// ============================================================\n// DATABASE OPTIONS\n// ============================================================\n\n/**\n * Database behavior options.\n */\nexport interface DatabaseOptions {\n  /** Database operation mode */\n  mode: DatabaseMode;\n  /** Enable WAL mode for better concurrency */\n  enableWAL: boolean;\n  /** Connection timeout in milliseconds */\n  connectionTimeoutMs: number;\n  /** Max retry attempts for failed operations */\n  maxRetries: number;\n  /** Base delay between retries (exponential backoff) */\n  retryDelayMs: number;\n  /** Vector dimensions for embeddings */\n  vectorDimensions: number;\n  /** Max neighbors for DiskANN index */\n  maxNeighbors: number;\n}\n\nexport const DatabaseOptionsSchema = z.object({\n  mode: z.enum(DATABASE_MODES),\n  enableWAL: z.boolean(),\n  connectionTimeoutMs: z.number().int().positive(),\n  maxRetries: z.number().int().min(0),\n  retryDelayMs: z.number().int().positive(),\n  vectorDimensions: z.number().int().positive(),\n  maxNeighbors: z.number().int().positive(),\n});\n\n/**\n * Creates default database options.\n */\nexport function createDefaultDatabaseOptions(): DatabaseOptions {\n  return {\n    mode: 'replica',\n    enableWAL: true,\n    connectionTimeoutMs: DB_DEFAULTS.connectionTimeoutMs,\n    maxRetries: DB_DEFAULTS.maxRetries,\n    retryDelayMs: DB_DEFAULTS.retryDelayMs,\n    vectorDimensions: DB_DEFAULTS.vectorDimensions,\n    maxNeighbors: DB_DEFAULTS.maxNeighbors,\n  };\n}\n\n// ============================================================\n// SYNC CONFIG\n// ============================================================\n\n/**\n * Sync behavior configuration.\n */\nexport interface SyncConfig {\n  /** Sync mode */\n  mode: SyncMode;\n  /** Minimum interval between syncs (ms) */\n  minIntervalMs: number;\n  /** Batch size for sync operations */\n  batchSize: number;\n  /** WiFi-only sync */\n  wifiOnly: boolean;\n  /** Sync only when charging */\n  chargingOnly: boolean;\n  /** Enable background sync */\n  backgroundSync: boolean;\n  /** Max retry attempts */\n  maxRetries: number;\n}\n\nexport const SyncConfigSchema = z.object({\n  mode: z.enum(SYNC_MODES),\n  minIntervalMs: z.number().int().positive(),\n  batchSize: z.number().int().positive(),\n  wifiOnly: z.boolean(),\n  chargingOnly: z.boolean(),\n  backgroundSync: z.boolean(),\n  maxRetries: z.number().int().min(0),\n});\n\n/**\n * Creates default sync configuration.\n */\nexport function createDefaultSyncConfig(): SyncConfig {\n  return {\n    mode: 'auto',\n    minIntervalMs: DB_DEFAULTS.syncIntervalMs,\n    batchSize: DB_DEFAULTS.syncBatchSize,\n    wifiOnly: false,\n    chargingOnly: false,\n    backgroundSync: true,\n    maxRetries: DB_DEFAULTS.maxRetries,\n  };\n}\n\n// ============================================================\n// TENANT CONFIG\n// ============================================================\n\n/**\n * Per-tenant configuration for database-per-user architecture.\n */\nexport interface TenantConfig {\n  /** Unique tenant identifier */\n  tenantId: string;\n  /** Privacy tier for this tenant */\n  privacyTier: PrivacyTier;\n  /** Tenant-specific database URL */\n  databaseUrl: string;\n  /** Tenant authentication token */\n  authToken: string;\n  /** Storage quota in bytes */\n  storageQuotaBytes: number;\n  /** Created timestamp */\n  createdAt: string;\n}\n\nexport const TenantConfigSchema = z.object({\n  tenantId: z.string().min(1),\n  privacyTier: z.enum(PRIVACY_TIERS),\n  databaseUrl: z.string().min(1),\n  authToken: z.string().min(1),\n  storageQuotaBytes: z.number().int().positive(),\n  createdAt: z.string().datetime(),\n});\n\n// ============================================================\n// INFRASTRUCTURE CONFIG\n// ============================================================\n\n/**\n * Complete infrastructure configuration.\n */\nexport interface InfrastructureConfig {\n  /** Turso connection settings */\n  turso: TursoConfig;\n  /** Database behavior options */\n  database: DatabaseOptions;\n  /** Sync configuration */\n  sync: SyncConfig;\n}\n\nexport const InfrastructureConfigSchema = z.object({\n  turso: TursoConfigSchema,\n  database: DatabaseOptionsSchema,\n  sync: SyncConfigSchema,\n});\n\n/**\n * Creates default infrastructure configuration.\n *\n * @param tursoConfig - Turso connection settings\n * @returns Complete infrastructure config with defaults\n */\nexport function createDefaultInfrastructureConfig(\n  tursoConfig: TursoConfig\n): InfrastructureConfig {\n  return {\n    turso: tursoConfig,\n    database: createDefaultDatabaseOptions(),\n    sync: createDefaultSyncConfig(),\n  };\n}\n\n// ============================================================\n// VALIDATION\n// ============================================================\n\n/**\n * Validates a Turso configuration.\n */\nexport function validateTursoConfig(config: unknown): config is TursoConfig {\n  return TursoConfigSchema.safeParse(config).success;\n}\n\n/**\n * Validates database options.\n */\nexport function validateDatabaseOptions(\n  options: unknown\n): options is DatabaseOptions {\n  return DatabaseOptionsSchema.safeParse(options).success;\n}\n\n/**\n * Validates sync configuration.\n */\nexport function validateSyncConfig(config: unknown): config is SyncConfig {\n  return SyncConfigSchema.safeParse(config).success;\n}\n\n/**\n * Validates complete infrastructure configuration.\n */\nexport function validateInfrastructureConfig(\n  config: unknown\n): config is InfrastructureConfig {\n  return InfrastructureConfigSchema.safeParse(config).success;\n}\n","/**\n * @module @nous/core/db/schema\n * @description SQL schema definitions for Turso/libSQL database\n * @version 1.0.0\n * @spec Brainstorms/Specs/storm-017\n * @storm Brainstorms/Infrastructure/storm-017-infrastructure-architecture\n *\n * Defines all database tables, indexes, and common queries.\n * Uses F32_BLOB for vector storage with DiskANN index.\n */\n\nimport { DB_DEFAULTS } from './config';\n\n// ============================================================\n// NODES TABLE\n// ============================================================\n\n/**\n * Main nodes table storing all node types with embeddings.\n *\n * Maps to NousNode interface from storm-011.\n * Supports vector search via DiskANN index.\n */\nexport const NODES_TABLE = `\nCREATE TABLE IF NOT EXISTS nodes (\n  -- Identity\n  id TEXT PRIMARY KEY NOT NULL,\n  type TEXT NOT NULL,\n  subtype TEXT,\n\n  -- Content (JSON encoded)\n  content_title TEXT,\n  content_summary TEXT,\n  content_body TEXT,\n  content_blocks TEXT,  -- JSON array of Block[]\n\n  -- Vector embedding for semantic search\n  embedding F32_BLOB(${DB_DEFAULTS.vectorDimensions}),\n\n  -- Neural properties\n  neural_stability REAL DEFAULT 0.5,\n  neural_retrievability REAL DEFAULT 0.5,\n  neural_access_count INTEGER DEFAULT 0,\n  neural_last_accessed TEXT,\n\n  -- State\n  state_lifecycle TEXT DEFAULT 'active',\n  state_extraction_depth TEXT DEFAULT 'core',\n\n  -- Provenance\n  provenance_source TEXT,\n  provenance_created_at TEXT NOT NULL,\n  provenance_confidence REAL DEFAULT 1.0,\n\n  -- Storage layer\n  layer TEXT NOT NULL DEFAULT 'semantic',\n\n  -- Sync metadata\n  version INTEGER DEFAULT 1,\n  last_modified TEXT NOT NULL,\n  last_modifier TEXT,\n  sync_status TEXT DEFAULT 'synced',\n\n  -- E2E encryption (for private tier)\n  encrypted_payload TEXT,\n  encryption_tier TEXT DEFAULT 'standard',\n\n  -- Indexes on created_at for temporal queries\n  created_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n/**\n * Indexes for the nodes table.\n */\nexport const NODES_INDEXES = `\n-- Vector similarity search index (DiskANN)\nCREATE INDEX IF NOT EXISTS idx_nodes_embedding\nON nodes (libsql_vector_idx(embedding, 'metric=cosine', 'max_neighbors=${DB_DEFAULTS.maxNeighbors}'));\n\n-- Type and subtype for filtering\nCREATE INDEX IF NOT EXISTS idx_nodes_type ON nodes (type);\nCREATE INDEX IF NOT EXISTS idx_nodes_subtype ON nodes (subtype);\n\n-- Layer routing\nCREATE INDEX IF NOT EXISTS idx_nodes_layer ON nodes (layer);\n\n-- Temporal queries\nCREATE INDEX IF NOT EXISTS idx_nodes_created_at ON nodes (created_at);\nCREATE INDEX IF NOT EXISTS idx_nodes_last_modified ON nodes (last_modified);\n\n-- Sync status\nCREATE INDEX IF NOT EXISTS idx_nodes_sync_status ON nodes (sync_status);\n\n-- Neural properties for retrieval scoring\nCREATE INDEX IF NOT EXISTS idx_nodes_stability ON nodes (neural_stability);\nCREATE INDEX IF NOT EXISTS idx_nodes_retrievability ON nodes (neural_retrievability);\n`;\n\n// ============================================================\n// EDGES TABLE\n// ============================================================\n\n/**\n * Edges table for relationships between nodes.\n *\n * Maps to NousEdge interface from storm-011.\n */\nexport const EDGES_TABLE = `\nCREATE TABLE IF NOT EXISTS edges (\n  -- Identity\n  id TEXT PRIMARY KEY NOT NULL,\n  type TEXT NOT NULL,\n\n  -- Relationship\n  source_id TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n  target_id TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n\n  -- Neural properties\n  neural_weight REAL DEFAULT 1.0,\n  neural_stability REAL DEFAULT 0.5,\n  neural_last_activated TEXT,\n\n  -- Metadata\n  bidirectional INTEGER DEFAULT 0,\n\n  -- Sync\n  version INTEGER DEFAULT 1,\n  last_modified TEXT NOT NULL,\n  created_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n/**\n * Indexes for the edges table.\n */\nexport const EDGES_INDEXES = `\n-- Efficient traversal\nCREATE INDEX IF NOT EXISTS idx_edges_source ON edges (source_id);\nCREATE INDEX IF NOT EXISTS idx_edges_target ON edges (target_id);\nCREATE INDEX IF NOT EXISTS idx_edges_type ON edges (type);\n\n-- Bidirectional lookup\nCREATE INDEX IF NOT EXISTS idx_edges_bidirectional ON edges (source_id, target_id);\n\n-- Weight for relevance\nCREATE INDEX IF NOT EXISTS idx_edges_weight ON edges (neural_weight);\n`;\n\n// ============================================================\n// EPISODES TABLE\n// ============================================================\n\n/**\n * Episodes table for time-indexed events.\n *\n * Maps to Episode interface from storm-004.\n * Includes TPS (Temporal Parsing System) metadata.\n */\nexport const EPISODES_TABLE = `\nCREATE TABLE IF NOT EXISTS episodes (\n  -- Identity\n  id TEXT PRIMARY KEY NOT NULL,\n\n  -- Content\n  content TEXT NOT NULL,\n  summary TEXT,\n\n  -- Temporal bounds\n  start_time TEXT NOT NULL,\n  end_time TEXT,\n\n  -- TPS Confidence Factors\n  tps_temporal_confidence REAL DEFAULT 0.5,\n  tps_parsing_method TEXT,\n  tps_source_reliability REAL DEFAULT 0.5,\n\n  -- References to nodes created from this episode\n  node_refs TEXT,  -- JSON array of node IDs\n\n  -- Source context\n  source_type TEXT,\n  source_id TEXT,\n\n  -- Sync\n  version INTEGER DEFAULT 1,\n  last_modified TEXT NOT NULL,\n  created_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n/**\n * Indexes for the episodes table.\n */\nexport const EPISODES_INDEXES = `\n-- Temporal range queries\nCREATE INDEX IF NOT EXISTS idx_episodes_start_time ON episodes (start_time);\nCREATE INDEX IF NOT EXISTS idx_episodes_end_time ON episodes (end_time);\n\n-- Source lookup\nCREATE INDEX IF NOT EXISTS idx_episodes_source ON episodes (source_type, source_id);\n`;\n\n// ============================================================\n// SYNC METADATA TABLE\n// ============================================================\n\n/**\n * Sync metadata table for tracking sync state.\n */\nexport const SYNC_METADATA_TABLE = `\nCREATE TABLE IF NOT EXISTS sync_metadata (\n  key TEXT PRIMARY KEY NOT NULL,\n  value TEXT NOT NULL,\n  updated_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n// ============================================================\n// USER SETTINGS TABLE\n// ============================================================\n\n/**\n * User settings table for preferences.\n */\nexport const USER_SETTINGS_TABLE = `\nCREATE TABLE IF NOT EXISTS user_settings (\n  key TEXT PRIMARY KEY NOT NULL,\n  value TEXT NOT NULL,\n  updated_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n// ============================================================\n// EDIT HISTORY TABLE\n// ============================================================\n\n/**\n * Edit history table for undo capability.\n *\n * Maps to EditRecord interface from storm-011.\n */\nexport const EDIT_HISTORY_TABLE = `\nCREATE TABLE IF NOT EXISTS edit_history (\n  id TEXT PRIMARY KEY NOT NULL,\n  node_id TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n  operation TEXT NOT NULL,  -- 'create' | 'update' | 'delete'\n  before_state TEXT,  -- JSON snapshot before edit\n  after_state TEXT,   -- JSON snapshot after edit\n  editor_id TEXT,\n  created_at TEXT NOT NULL DEFAULT (datetime('now'))\n);\n`;\n\n/**\n * Indexes for edit history.\n */\nexport const EDIT_HISTORY_INDEXES = `\nCREATE INDEX IF NOT EXISTS idx_edit_history_node ON edit_history (node_id);\nCREATE INDEX IF NOT EXISTS idx_edit_history_created ON edit_history (created_at);\n`;\n\n// ============================================================\n// LOCAL CACHE TABLE\n// ============================================================\n\n/**\n * Local cache table for LRU cache on limited storage.\n */\nexport const LOCAL_CACHE_TABLE = `\nCREATE TABLE IF NOT EXISTS local_cache (\n  node_id TEXT PRIMARY KEY NOT NULL,\n  cached_at TEXT NOT NULL,\n  last_accessed TEXT NOT NULL,\n  access_count INTEGER DEFAULT 1,\n  size_bytes INTEGER NOT NULL\n);\n`;\n\n/**\n * Indexes for local cache.\n */\nexport const LOCAL_CACHE_INDEXES = `\nCREATE INDEX IF NOT EXISTS idx_local_cache_last_accessed ON local_cache (last_accessed);\nCREATE INDEX IF NOT EXISTS idx_local_cache_access_count ON local_cache (access_count);\n`;\n\n// ============================================================\n// SCHEMA VERSION TABLE\n// ============================================================\n\n/**\n * Schema version table for migration tracking.\n */\nexport const SCHEMA_VERSION_TABLE = `\nCREATE TABLE IF NOT EXISTS schema_version (\n  version INTEGER PRIMARY KEY NOT NULL,\n  applied_at TEXT NOT NULL DEFAULT (datetime('now')),\n  description TEXT\n);\n`;\n\n// ============================================================\n// FULL SCHEMA\n// ============================================================\n\n/**\n * Complete schema creation statements in order.\n *\n * Execute in order to create full database schema.\n */\nexport const FULL_SCHEMA: string[] = [\n  NODES_TABLE,\n  NODES_INDEXES,\n  EDGES_TABLE,\n  EDGES_INDEXES,\n  EPISODES_TABLE,\n  EPISODES_INDEXES,\n  SYNC_METADATA_TABLE,\n  USER_SETTINGS_TABLE,\n  EDIT_HISTORY_TABLE,\n  EDIT_HISTORY_INDEXES,\n  LOCAL_CACHE_TABLE,\n  LOCAL_CACHE_INDEXES,\n  SCHEMA_VERSION_TABLE,\n];\n\n// ============================================================\n// COMMON QUERIES\n// ============================================================\n\n/**\n * Common query templates.\n */\nexport const QUERIES = {\n  /**\n   * Vector similarity search query.\n   * Uses cosine distance via DiskANN index.\n   */\n  vectorSearch: `\n    SELECT\n      id,\n      type,\n      content_title,\n      content_summary,\n      vector_distance_cos(embedding, ?) as distance\n    FROM nodes\n    WHERE embedding IS NOT NULL\n      AND layer = ?\n    ORDER BY distance ASC\n    LIMIT ?\n  `,\n\n  /**\n   * Get node by ID.\n   */\n  getNodeById: `\n    SELECT * FROM nodes WHERE id = ?\n  `,\n\n  /**\n   * Get edges for a node (both directions).\n   */\n  getEdgesForNode: `\n    SELECT * FROM edges\n    WHERE source_id = ? OR target_id = ?\n  `,\n\n  /**\n   * Get outgoing edges from a node.\n   */\n  getOutgoingEdges: `\n    SELECT * FROM edges WHERE source_id = ?\n  `,\n\n  /**\n   * Get incoming edges to a node.\n   */\n  getIncomingEdges: `\n    SELECT * FROM edges WHERE target_id = ?\n  `,\n\n  /**\n   * Get episodes in time range.\n   */\n  getEpisodesInRange: `\n    SELECT * FROM episodes\n    WHERE start_time >= ? AND (end_time IS NULL OR end_time <= ?)\n    ORDER BY start_time ASC\n  `,\n\n  /**\n   * Get nodes with sync conflicts.\n   */\n  getSyncConflicts: `\n    SELECT * FROM nodes WHERE sync_status = 'conflict'\n  `,\n\n  /**\n   * Get unsynced changes.\n   */\n  getUnsyncedChanges: `\n    SELECT * FROM nodes WHERE sync_status = 'pending'\n  `,\n\n  /**\n   * Insert new node.\n   */\n  insertNode: `\n    INSERT INTO nodes (\n      id, type, subtype,\n      content_title, content_summary, content_body, content_blocks,\n      embedding,\n      neural_stability, neural_retrievability, neural_access_count,\n      state_lifecycle, state_extraction_depth,\n      provenance_source, provenance_created_at, provenance_confidence,\n      layer, version, last_modified, last_modifier\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `,\n\n  /**\n   * Insert new episode.\n   */\n  insertEpisode: `\n    INSERT INTO episodes (\n      id, content, summary,\n      start_time, end_time,\n      tps_temporal_confidence, tps_parsing_method, tps_source_reliability,\n      node_refs, source_type, source_id,\n      version, last_modified\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `,\n\n  /**\n   * Update node sync status.\n   */\n  updateSyncStatus: `\n    UPDATE nodes SET sync_status = ?, last_modified = ? WHERE id = ?\n  `,\n\n  /**\n   * Get schema version.\n   */\n  getSchemaVersion: `\n    SELECT MAX(version) as version FROM schema_version\n  `,\n\n  /**\n   * Insert schema version.\n   */\n  insertSchemaVersion: `\n    INSERT INTO schema_version (version, description) VALUES (?, ?)\n  `,\n} as const;\n\n// ============================================================\n// SCHEMA HELPERS\n// ============================================================\n\n/**\n * Gets all CREATE TABLE statements.\n */\nexport function getTableStatements(): string[] {\n  return [\n    NODES_TABLE,\n    EDGES_TABLE,\n    EPISODES_TABLE,\n    SYNC_METADATA_TABLE,\n    USER_SETTINGS_TABLE,\n    EDIT_HISTORY_TABLE,\n    LOCAL_CACHE_TABLE,\n    SCHEMA_VERSION_TABLE,\n  ];\n}\n\n/**\n * Gets all CREATE INDEX statements.\n */\nexport function getIndexStatements(): string[] {\n  return [\n    NODES_INDEXES,\n    EDGES_INDEXES,\n    EPISODES_INDEXES,\n    EDIT_HISTORY_INDEXES,\n    LOCAL_CACHE_INDEXES,\n  ];\n}\n\n/**\n * Gets drop statements for all tables (for testing/reset).\n */\nexport function getDropStatements(): string[] {\n  return [\n    'DROP TABLE IF EXISTS edit_history',\n    'DROP TABLE IF EXISTS local_cache',\n    'DROP TABLE IF EXISTS edges',\n    'DROP TABLE IF EXISTS episodes',\n    'DROP TABLE IF EXISTS nodes',\n    'DROP TABLE IF EXISTS sync_metadata',\n    'DROP TABLE IF EXISTS user_settings',\n    'DROP TABLE IF EXISTS schema_version',\n  ];\n}\n","/**\n * @module @nous/core/db/adapter\n * @description Database adapter interface for Turso/libSQL\n * @version 1.0.0\n * @spec Brainstorms/Specs/storm-017\n * @storm Brainstorms/Infrastructure/storm-017-infrastructure-architecture\n *\n * Defines the abstract database adapter interface that can be implemented\n * for different database backends (Turso cloud, local libSQL, etc.)\n */\n\nimport { z } from 'zod';\nimport type { StorageLayer } from '../storage';\n\n// ============================================================\n// QUERY RESULT\n// ============================================================\n\n/**\n * Result of a query execution.\n */\nexport interface QueryResult<T = Record<string, unknown>> {\n  /** Rows returned by the query */\n  rows: T[];\n  /** Number of rows affected (for mutations) */\n  rowsAffected: number;\n  /** Last inserted row ID (for inserts) */\n  lastInsertRowid?: bigint;\n}\n\nexport const QueryResultSchema = z.object({\n  rows: z.array(z.record(z.unknown())),\n  rowsAffected: z.number().int().min(0),\n  lastInsertRowid: z.bigint().optional(),\n});\n\n// ============================================================\n// BATCH OPERATIONS\n// ============================================================\n\n/**\n * Statement for batch execution.\n */\nexport interface BatchStatement {\n  /** SQL query */\n  sql: string;\n  /** Query parameters */\n  args?: unknown[];\n}\n\n/**\n * Result of a batch operation.\n */\nexport interface BatchResult {\n  /** Individual results for each statement */\n  results: QueryResult[];\n  /** Total rows affected across all statements */\n  totalRowsAffected: number;\n}\n\n// ============================================================\n// TRANSACTION\n// ============================================================\n\n/**\n * Transaction handle for atomic operations.\n */\nexport interface Transaction {\n  /** Execute query within transaction */\n  execute<T = Record<string, unknown>>(\n    sql: string,\n    args?: unknown[]\n  ): Promise<QueryResult<T>>;\n\n  /** Execute batch within transaction */\n  batch(statements: BatchStatement[]): Promise<BatchResult>;\n\n  /** Commit the transaction */\n  commit(): Promise<void>;\n\n  /** Rollback the transaction */\n  rollback(): Promise<void>;\n\n  /** Check if transaction is still active */\n  isActive(): boolean;\n}\n\n// ============================================================\n// CONNECTION INFO\n// ============================================================\n\n/**\n * Database connection state information.\n */\nexport interface ConnectionInfo {\n  /** Whether connected to database */\n  connected: boolean;\n  /** Database URL */\n  url: string;\n  /** Connection mode */\n  mode: 'local' | 'cloud' | 'replica';\n  /** Time of last successful connection */\n  connectedAt?: string;\n  /** Current latency to database (ms) */\n  latencyMs?: number;\n}\n\n// ============================================================\n// VECTOR SEARCH\n// ============================================================\n\n/**\n * Options for vector similarity search.\n */\nexport interface VectorSearchOptions {\n  /** Query embedding vector */\n  embedding: Float32Array;\n  /** Maximum number of results */\n  limit: number;\n  /** Minimum similarity score (0-1) */\n  minScore?: number;\n  /** Storage layer to search */\n  layer?: StorageLayer;\n  /** Additional filters */\n  filters?: Record<string, unknown>;\n  /** Include distance in results */\n  includeDistance?: boolean;\n}\n\nexport const VectorSearchOptionsSchema = z.object({\n  embedding: z.instanceof(Float32Array),\n  limit: z.number().int().positive().max(1000),\n  minScore: z.number().min(0).max(1).optional(),\n  layer: z.enum(['semantic', 'episode', 'archive']).optional(),\n  filters: z.record(z.unknown()).optional(),\n  includeDistance: z.boolean().optional(),\n});\n\n/**\n * Result of a vector similarity search.\n */\nexport interface VectorSearchResult {\n  /** Node ID */\n  nodeId: string;\n  /** Node type */\n  type: string;\n  /** Content title */\n  title?: string;\n  /** Content summary */\n  summary?: string;\n  /** Cosine distance (0 = identical, 2 = opposite) */\n  distance: number;\n  /** Similarity score (1 - distance/2) */\n  score: number;\n}\n\n// ============================================================\n// SYNC RESULT\n// ============================================================\n\n/**\n * Result of a sync operation.\n */\nexport interface SyncResult {\n  /** Whether sync succeeded */\n  success: boolean;\n  /** Number of frames synced */\n  framesSynced: number;\n  /** Current frame number */\n  currentFrame: number;\n  /** Duration in milliseconds */\n  durationMs: number;\n  /** Error message if failed */\n  error?: string;\n  /** Number of conflicts detected */\n  conflictsDetected: number;\n  /** Number of conflicts auto-resolved */\n  conflictsAutoResolved: number;\n}\n\n// ============================================================\n// HEALTH CHECK\n// ============================================================\n\n/**\n * Result of a health check.\n */\nexport interface HealthCheckResult {\n  /** Overall health status */\n  healthy: boolean;\n  /** Database connection status */\n  connected: boolean;\n  /** Sync status */\n  syncStatus: 'synced' | 'pending' | 'error';\n  /** Latency in milliseconds */\n  latencyMs: number;\n  /** Pending changes count */\n  pendingChanges: number;\n  /** Unresolved conflicts count */\n  unresolvedConflicts: number;\n  /** Last successful sync */\n  lastSyncAt?: string;\n  /** Any error messages */\n  errors: string[];\n}\n\n// ============================================================\n// DATABASE ADAPTER INTERFACE\n// ============================================================\n\n/**\n * Abstract database adapter interface.\n *\n * Provides a common interface for database operations that can be\n * implemented for different backends (Turso, local SQLite, etc.)\n *\n * @example\n * ```typescript\n * const adapter: DatabaseAdapter = new TursoDatabaseAdapter(config);\n * await adapter.connect();\n * const result = await adapter.execute('SELECT * FROM nodes WHERE id = ?', ['node-123']);\n * await adapter.disconnect();\n * ```\n */\nexport interface DatabaseAdapter {\n  // ==================== CONNECTION ====================\n\n  /**\n   * Connects to the database.\n   *\n   * @throws Error if connection fails\n   */\n  connect(): Promise<void>;\n\n  /**\n   * Disconnects from the database.\n   */\n  disconnect(): Promise<void>;\n\n  /**\n   * Gets current connection info.\n   */\n  getConnectionInfo(): ConnectionInfo;\n\n  // ==================== QUERY EXECUTION ====================\n\n  /**\n   * Executes a single SQL query.\n   *\n   * @param sql - SQL query string\n   * @param args - Query parameters\n   * @returns Query result\n   */\n  execute<T = Record<string, unknown>>(\n    sql: string,\n    args?: unknown[]\n  ): Promise<QueryResult<T>>;\n\n  /**\n   * Executes multiple queries in a batch.\n   *\n   * @param statements - Array of SQL statements\n   * @returns Batch result\n   */\n  batch(statements: BatchStatement[]): Promise<BatchResult>;\n\n  // ==================== TRANSACTIONS ====================\n\n  /**\n   * Begins a new transaction.\n   *\n   * @returns Transaction handle\n   */\n  beginTransaction(): Promise<Transaction>;\n\n  // ==================== VECTOR SEARCH ====================\n\n  /**\n   * Performs vector similarity search.\n   *\n   * @param options - Search options\n   * @returns Array of search results ordered by similarity\n   */\n  vectorSearch(options: VectorSearchOptions): Promise<VectorSearchResult[]>;\n\n  // ==================== SYNC ====================\n\n  /**\n   * Syncs with remote database (for replica mode).\n   *\n   * @returns Sync result\n   */\n  sync(): Promise<SyncResult>;\n\n  // ==================== SCHEMA ====================\n\n  /**\n   * Gets the current schema version.\n   */\n  getSchemaVersion(): Promise<number>;\n\n  /**\n   * Runs pending migrations.\n   *\n   * @param targetVersion - Target schema version (default: latest)\n   */\n  runMigrations(targetVersion?: number): Promise<void>;\n\n  // ==================== HEALTH ====================\n\n  /**\n   * Performs a health check.\n   */\n  healthCheck(): Promise<HealthCheckResult>;\n}\n\n// ============================================================\n// HELPER TYPES\n// ============================================================\n\n/**\n * Type for row transformer functions.\n */\nexport type RowTransformer<T> = (row: Record<string, unknown>) => T;\n\n/**\n * Creates a type-safe row transformer.\n */\nexport function createRowTransformer<T>(\n  transform: (row: Record<string, unknown>) => T\n): RowTransformer<T> {\n  return transform;\n}\n\n// ============================================================\n// ERROR TYPES\n// ============================================================\n\n/**\n * Database error codes.\n */\nexport const DB_ERROR_CODES = [\n  'CONNECTION_FAILED',\n  'QUERY_FAILED',\n  'TRANSACTION_FAILED',\n  'SYNC_FAILED',\n  'MIGRATION_FAILED',\n  'TIMEOUT',\n  'CONFLICT',\n] as const;\n\nexport type DbErrorCode = (typeof DB_ERROR_CODES)[number];\n\n/**\n * Database-specific error.\n */\nexport class DatabaseError extends Error {\n  constructor(\n    public code: DbErrorCode,\n    message: string,\n    public cause?: Error\n  ) {\n    super(message);\n    this.name = 'DatabaseError';\n  }\n}\n\n// ============================================================\n// VALIDATION\n// ============================================================\n\n/**\n * Validates vector search options.\n */\nexport function validateVectorSearchOptions(\n  options: unknown\n): options is VectorSearchOptions {\n  return VectorSearchOptionsSchema.safeParse(options).success;\n}\n","/**\n * @module @nous/core/db/turso-adapter\n * @description Turso/libSQL specific adapter implementation\n * @version 1.0.0\n * @spec Brainstorms/Specs/storm-017\n * @storm Brainstorms/Infrastructure/storm-017-infrastructure-architecture\n *\n * Provides Turso-specific implementation of DatabaseAdapter interface.\n * Uses @libsql/client for database operations.\n *\n * Note: This file defines interfaces and helpers. The actual implementation\n * using @libsql/client should be done in the apps that use this package.\n */\n\nimport type {\n  DatabaseAdapter,\n  QueryResult,\n  VectorSearchOptions,\n  VectorSearchResult,\n  SyncResult,\n  RowTransformer,\n} from './adapter';\nimport type { TursoConfig, DatabaseOptions, SyncConfig } from './config';\nimport type { StorageLayer } from '../storage';\n\n// ============================================================\n// TURSO ADAPTER INTERFACE\n// ============================================================\n\n/**\n * Turso-specific database adapter.\n *\n * Extends DatabaseAdapter with Turso-specific configuration.\n */\nexport interface TursoDatabaseAdapter extends DatabaseAdapter {\n  /** Turso connection configuration */\n  readonly config: TursoConfig;\n  /** Database behavior options */\n  readonly options: DatabaseOptions;\n  /** Sync configuration */\n  readonly syncConfig: SyncConfig;\n}\n\n// ============================================================\n// ROW TRANSFORMER HELPERS\n// ============================================================\n\n/**\n * Node row from database.\n */\nexport interface NodeRow {\n  id: string;\n  type: string;\n  subtype: string | null;\n  content_title: string | null;\n  content_summary: string | null;\n  content_body: string | null;\n  content_blocks: string | null;\n  embedding: ArrayBuffer | null;\n  neural_stability: number;\n  neural_retrievability: number;\n  neural_access_count: number;\n  neural_last_accessed: string | null;\n  state_lifecycle: string;\n  state_extraction_depth: string;\n  provenance_source: string | null;\n  provenance_created_at: string;\n  provenance_confidence: number;\n  layer: string;\n  version: number;\n  last_modified: string;\n  last_modifier: string | null;\n  sync_status: string;\n  encrypted_payload: string | null;\n  encryption_tier: string;\n  created_at: string;\n}\n\n/**\n * Edge row from database.\n */\nexport interface EdgeRow {\n  id: string;\n  type: string;\n  source_id: string;\n  target_id: string;\n  neural_weight: number;\n  neural_stability: number;\n  neural_last_activated: string | null;\n  bidirectional: number;\n  version: number;\n  last_modified: string;\n  created_at: string;\n}\n\n/**\n * Episode row from database.\n */\nexport interface EpisodeRow {\n  id: string;\n  content: string;\n  summary: string | null;\n  start_time: string;\n  end_time: string | null;\n  tps_temporal_confidence: number;\n  tps_parsing_method: string | null;\n  tps_source_reliability: number;\n  node_refs: string | null;\n  source_type: string | null;\n  source_id: string | null;\n  version: number;\n  last_modified: string;\n  created_at: string;\n}\n\n// Note: createRowTransformer is exported from adapter.ts\n\n/**\n * Transforms a Turso result to QueryResult.\n */\nexport function transformTursoResult<T>(\n  tursoResult: {\n    rows: Array<Record<string, unknown>>;\n    rowsAffected: number;\n    lastInsertRowid?: bigint;\n  },\n  transformer?: RowTransformer<T>\n): QueryResult<T> {\n  return {\n    rows: transformer\n      ? tursoResult.rows.map(transformer)\n      : (tursoResult.rows as T[]),\n    rowsAffected: tursoResult.rowsAffected,\n    lastInsertRowid: tursoResult.lastInsertRowid,\n  };\n}\n\n// ============================================================\n// VECTOR SEARCH HELPERS\n// ============================================================\n\n/**\n * Builds a vector search SQL query.\n *\n * @param options - Vector search options\n * @returns Tuple of [sql, params]\n */\nexport function buildVectorSearchQuery(\n  options: VectorSearchOptions\n): [string, unknown[]] {\n  const params: unknown[] = [options.embedding];\n  const conditions: string[] = ['embedding IS NOT NULL'];\n\n  if (options.layer) {\n    conditions.push('layer = ?');\n    params.push(options.layer);\n  }\n\n  if (options.filters) {\n    for (const [key, value] of Object.entries(options.filters)) {\n      if (value !== undefined) {\n        conditions.push(`${key} = ?`);\n        params.push(value);\n      }\n    }\n  }\n\n  params.push(options.limit);\n\n  const sql = `\n    SELECT\n      id,\n      type,\n      content_title,\n      content_summary,\n      vector_distance_cos(embedding, ?) as distance\n    FROM nodes\n    WHERE ${conditions.join(' AND ')}\n    ORDER BY distance ASC\n    LIMIT ?\n  `;\n\n  return [sql.trim(), params];\n}\n\n/**\n * Transforms raw vector search row to VectorSearchResult.\n */\nexport function transformVectorSearchResult(\n  row: Record<string, unknown>\n): VectorSearchResult {\n  const distance = row['distance'] as number;\n  return {\n    nodeId: row['id'] as string,\n    type: row['type'] as string,\n    title: row['content_title'] as string | undefined,\n    summary: row['content_summary'] as string | undefined,\n    distance,\n    score: 1 - distance / 2, // Convert distance to similarity score\n  };\n}\n\n// ============================================================\n// SYNC HELPERS\n// ============================================================\n\n/**\n * Sync statistics.\n */\nexport interface SyncStats {\n  framesTotal: number;\n  framesSynced: number;\n  bytesTransferred: number;\n  durationMs: number;\n}\n\n/**\n * Calculates sync statistics.\n */\nexport function calculateSyncStats(\n  startTime: number,\n  framesTotal: number,\n  framesSynced: number,\n  bytesTransferred: number\n): SyncStats {\n  return {\n    framesTotal,\n    framesSynced,\n    bytesTransferred,\n    durationMs: Date.now() - startTime,\n  };\n}\n\n/**\n * Creates a successful sync result.\n */\nexport function createSuccessSyncResult(stats: SyncStats): SyncResult {\n  return {\n    success: true,\n    framesSynced: stats.framesSynced,\n    currentFrame: stats.framesTotal,\n    durationMs: stats.durationMs,\n    conflictsDetected: 0,\n    conflictsAutoResolved: 0,\n  };\n}\n\n/**\n * Creates a failed sync result.\n */\nexport function createFailedSyncResult(\n  error: string,\n  durationMs: number\n): SyncResult {\n  return {\n    success: false,\n    framesSynced: 0,\n    currentFrame: 0,\n    durationMs,\n    error,\n    conflictsDetected: 0,\n    conflictsAutoResolved: 0,\n  };\n}\n\n// ============================================================\n// CONNECTION HELPERS\n// ============================================================\n\n/**\n * Parses a database URL to determine the mode.\n */\nexport function parseDatabaseUrl(\n  url: string\n): 'local' | 'cloud' | 'replica' {\n  if (url.startsWith('file:')) {\n    return 'local';\n  }\n  if (url.startsWith('libsql://') || url.startsWith('https://')) {\n    return 'cloud';\n  }\n  // Default to replica for other cases\n  return 'replica';\n}\n\n/**\n * Validates a Turso URL format.\n */\nexport function isValidTursoUrl(url: string): boolean {\n  try {\n    if (url.startsWith('file:')) {\n      return true;\n    }\n    new URL(url);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n// ============================================================\n// RETRY HELPERS\n// ============================================================\n\n/**\n * Retry configuration.\n */\nexport interface RetryConfig {\n  maxRetries: number;\n  baseDelayMs: number;\n  maxDelayMs: number;\n}\n\n/**\n * Default retry configuration.\n */\nexport const DEFAULT_RETRY_CONFIG: RetryConfig = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 30000,\n};\n\n/**\n * Calculates exponential backoff delay.\n */\nexport function calculateBackoffDelay(\n  attempt: number,\n  config: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n  const delay = config.baseDelayMs * Math.pow(2, attempt);\n  return Math.min(delay, config.maxDelayMs);\n}\n\n/**\n * Retries an async operation with exponential backoff.\n */\nexport async function retryWithBackoff<T>(\n  operation: () => Promise<T>,\n  config: RetryConfig = DEFAULT_RETRY_CONFIG\n): Promise<T> {\n  let lastError: Error | undefined;\n\n  for (let attempt = 0; attempt <= config.maxRetries; attempt++) {\n    try {\n      return await operation();\n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n\n      if (attempt < config.maxRetries) {\n        const delay = calculateBackoffDelay(attempt, config);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n      }\n    }\n  }\n\n  throw lastError;\n}\n\n// ============================================================\n// EMBEDDING HELPERS\n// ============================================================\n\n/**\n * Converts an embedding array to Float32Array for database storage.\n */\nexport function toFloat32Array(embedding: number[]): Float32Array {\n  return new Float32Array(embedding);\n}\n\n/**\n * Converts a Float32Array to regular array.\n */\nexport function fromFloat32Array(buffer: Float32Array): number[] {\n  return Array.from(buffer);\n}\n\n/**\n * Validates embedding dimensions.\n */\nexport function validateEmbeddingDimensions(\n  embedding: Float32Array | number[],\n  expectedDimensions: number\n): boolean {\n  return embedding.length === expectedDimensions;\n}\n\n// ============================================================\n// LAYER ROUTING\n// ============================================================\n\n/**\n * Gets the appropriate layer for a node type.\n *\n * This is a simplified version - the full implementation uses\n * getStorageLayer from ../storage.\n */\nexport function getLayerForQuery(\n  layer?: StorageLayer\n): StorageLayer {\n  return layer ?? 'semantic';\n}\n"]}