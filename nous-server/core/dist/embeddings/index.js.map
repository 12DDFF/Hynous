{"version":3,"sources":["../../src/embeddings/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @module @nous/core/embeddings\n * @description Contextual Embedding Ecosystem (CEE) - semantic representation for Nous\n * @version 1.0.0\n * @spec Brainstorms/Specs/Phase-2-Data-Representation/storm-016\n *\n * This module implements:\n * - NodeEmbedding interface (expands storm-011 EmbeddingField)\n * - Context prefix generation for all node types\n * - Hybrid search configuration (Dense + BM25)\n * - Matryoshka staged search support\n * - Provider fallback chain\n * - Similarity-based edge creation\n *\n * Core principle: \"Context in, context out.\"\n * Every embedding carries its origins - where information came from,\n * what it relates to, when it happened.\n */\n\nimport { z } from 'zod';\n\n// ============================================================\n// CONSTANTS\n// ============================================================\n\n/**\n * Full embedding vector dimensions (OpenAI text-embedding-3-small)\n */\nexport const EMBEDDING_DIMENSIONS = 1536;\n\n/**\n * Matryoshka truncation dimensions for staged search\n */\nexport const MATRYOSHKA_DIMS = [128, 512, 1536] as const;\n\n/**\n * Dimension used for fast similarity comparisons\n */\nexport const COMPARISON_DIMS = 512;\n\n/**\n * Weight for dense (vector) search in hybrid retrieval\n */\nexport const DENSE_WEIGHT = 0.7;\n\n/**\n * Weight for BM25 (keyword) search in hybrid retrieval\n */\nexport const BM25_WEIGHT = 0.3;\n\n/**\n * Minimum cosine similarity for automatic 'similar_to' edge creation\n */\nexport const SIMILARITY_EDGE_THRESHOLD = 0.90;\n\n/**\n * Cosine similarity threshold triggering deduplication check\n */\nexport const DEDUP_CHECK_THRESHOLD = 0.95;\n\n/**\n * Minimum similarity for SSA seeding\n */\nexport const SSA_SEED_THRESHOLD = 0.60;\n\n/**\n * Threshold for removing stale similarity edges\n */\nexport const STALE_EDGE_THRESHOLD = 0.80;\n\n/**\n * Minimum content length before context expansion\n */\nexport const MIN_CONTENT_LENGTH = 10;\n\n/**\n * Minimum total length (content + prefix) for embedding\n */\nexport const MIN_TOTAL_LENGTH = 50;\n\n/**\n * Stage 1 (coarse): Candidates from HNSW search\n */\nexport const STAGE_1_CANDIDATES = 200;\n\n/**\n * Stage 2 (medium): Candidates after rerank\n */\nexport const STAGE_2_CANDIDATES = 50;\n\n/**\n * Stage 3 (fine): Final candidates\n */\nexport const STAGE_3_CANDIDATES = 30;\n\n/**\n * Primary embedding model\n */\nexport const PRIMARY_MODEL = 'openai-3-small' as const;\n\n/**\n * Fallback 1: Voyage AI\n */\nexport const FALLBACK_1_MODEL = 'voyage-3-lite' as const;\n\n/**\n * Fallback 2: Local MiniLM\n */\nexport const FALLBACK_2_MODEL = 'minilm-v6' as const;\n\n/**\n * All supported embedding models\n */\nexport const EMBEDDING_MODELS = [\n  PRIMARY_MODEL,\n  FALLBACK_1_MODEL,\n  FALLBACK_2_MODEL,\n] as const;\n\n/**\n * Number of recent nodes to compare against for similarity edges\n */\nexport const RECENT_NODE_WINDOW = 100;\n\n/**\n * Retry delay between provider attempts (ms)\n */\nexport const FALLBACK_RETRY_DELAY_MS = 1000;\n\n/**\n * Max retries per provider\n */\nexport const FALLBACK_MAX_RETRIES = 2;\n\n/**\n * BM25 field weights\n */\nexport const BM25_FIELD_WEIGHTS = {\n  title: 2.0,\n  body: 1.0,\n  summary: 1.5,\n  tags: 1.5,\n} as const;\n\n// ============================================================\n// TYPES\n// ============================================================\n\nexport type EmbeddingModelId = (typeof EMBEDDING_MODELS)[number] | string;\nexport type MatryoshkaDim = (typeof MATRYOSHKA_DIMS)[number];\n\n/**\n * Embedding structure attached to each node\n * Extends storm-011's EmbeddingField placeholder\n */\nexport interface NodeEmbedding {\n  /** The embedding vector (Float32Array) */\n  vector: Float32Array;\n  /** Number of dimensions in the vector */\n  dimensions: number;\n  /** Model identifier that generated this embedding */\n  model: EmbeddingModelId;\n  /** Full context prefix prepended to content */\n  contextPrefix: string;\n  /** Hash of context prefix for change detection */\n  contextHash: string;\n  /** ISO 8601 timestamp when embedding was created */\n  createdAt: string;\n  /** True if embedding was created using a fallback model */\n  provisional: boolean;\n  /** Version counter, incremented on each re-embedding */\n  version: number;\n}\n\n/**\n * Context prefix template identifiers\n */\nexport type ContextPrefixTemplate =\n  | 'concept_extracted'\n  | 'concept_manual'\n  | 'episode'\n  | 'document_chunk'\n  | 'section'\n  | 'note'\n  | 'raw_archive'\n  | 'query';\n\n/**\n * Generated context prefix with metadata\n */\nexport interface ContextPrefix {\n  template: ContextPrefixTemplate;\n  generated: string;\n  hash: string;\n}\n\n/**\n * Hybrid search configuration\n */\nexport interface HybridSearchConfig {\n  denseWeight: number;\n  bm25Weight: number;\n  userTunable: boolean;\n}\n\n/**\n * Individual search result with component scores\n */\nexport interface HybridSearchResult {\n  nodeId: string;\n  denseScore: number;\n  bm25Score: number;\n  fusedScore: number;\n}\n\n/**\n * Matryoshka stage configuration\n */\nexport interface MatryoshkaStageConfig {\n  stage: 1 | 2 | 3;\n  dimensions: 128 | 512 | 1536;\n  candidates: number;\n  estimatedLatencyMs: number;\n}\n\n/**\n * Search filters\n */\nexport interface SearchFilters {\n  timeRange?: { start: string; end: string };\n  nodeTypes?: string[];\n  clusterIds?: string[];\n  excludeNodeIds?: string[];\n}\n\n/**\n * Result of processing a query\n */\nexport interface QueryEmbeddingResult {\n  dense: Float32Array;\n  bm25Terms: string[];\n  timeFilter?: { start: string; end: string; confidence: number };\n  typeFilter?: string[];\n  isPurelyTemporal: boolean;\n}\n\n/**\n * Query analysis result\n */\nexport interface QueryAnalysis {\n  hasTimeReference: boolean;\n  hasSemanticContent: boolean;\n  expectedTypes: string[];\n  semanticPart: string;\n  originalQuery: string;\n}\n\n/**\n * Similarity check result\n */\nexport interface SimilarityCheckResult {\n  shouldCreateEdge: boolean;\n  shouldCheckDedup: boolean;\n  similarity: number;\n  targetNodeId: string;\n}\n\n/**\n * Fallback levels\n */\nexport type FallbackLevel = 'primary' | 'secondary' | 'local' | 'degraded';\n\n/**\n * Provider health status\n */\nexport interface ProviderHealth {\n  isAvailable: boolean;\n  lastSuccessAt?: string;\n  lastFailureAt?: string;\n  lastError?: string;\n  consecutiveFailures: number;\n}\n\n/**\n * Fallback configuration\n */\nexport interface FallbackConfig {\n  chain: EmbeddingModelId[];\n  retryDelayMs: number;\n  maxRetries: number;\n  autoReEmbed: boolean;\n}\n\n/**\n * Fallback state\n */\nexport interface FallbackState {\n  currentLevel: FallbackLevel;\n  lastError?: string;\n  recoveryAttempts: number;\n  degradedSince?: string;\n  providerHealth: Record<string, ProviderHealth>;\n}\n\n/**\n * Embedding result\n */\nexport interface EmbedResult {\n  embedding: NodeEmbedding | null;\n  fallbackLevel: FallbackLevel;\n  modelUsed?: EmbeddingModelId;\n  error?: string;\n  latencyMs: number;\n  isProvisional: boolean;\n}\n\n/**\n * Context generator input\n */\nexport interface ContextGeneratorInput {\n  nodeType: string;\n  nodeSubtype?: string;\n  title: string;\n  sourceEpisode?: { title: string; subtype: string };\n  clusterInfo?: { name: string; description?: string; keywords?: string[] };\n  chunkInfo?: { index: number; total: number; sectionTitle?: string; parentTitle: string };\n  eventTimestamp?: string;\n  durationMinutes?: number;\n  participants?: string[];\n  contentType?: string;\n  sourceType?: 'extraction' | 'manual' | 'inference' | 'import';\n}\n\n/**\n * Similarity edge configuration\n */\nexport interface SimilarityEdgeConfig {\n  edgeThreshold: number;\n  dedupThreshold: number;\n  staleThreshold: number;\n  recentNodeWindow: number;\n  comparisonDims: number;\n}\n\n/**\n * Provider configuration\n */\nexport interface EmbeddingProviderConfig {\n  id: EmbeddingModelId;\n  name: string;\n  apiEndpoint: string;\n  modelName: string;\n  dimensions: number;\n  supportsMatryoshka: boolean;\n  costPer1MTokens: number;\n  maxTokens: number;\n  isLocal: boolean;\n}\n\n// ============================================================\n// ZOD SCHEMAS\n// ============================================================\n\nexport const NodeEmbeddingSchema = z.object({\n  vector: z.instanceof(Float32Array),\n  dimensions: z.number().int().positive().max(EMBEDDING_DIMENSIONS),\n  model: z.string().min(1),\n  contextPrefix: z.string(),\n  contextHash: z.string().min(1),\n  createdAt: z.string().datetime(),\n  provisional: z.boolean(),\n  version: z.number().int().nonnegative(),\n});\n\nexport const ContextPrefixSchema = z.object({\n  template: z.enum([\n    'concept_extracted',\n    'concept_manual',\n    'episode',\n    'document_chunk',\n    'section',\n    'note',\n    'raw_archive',\n    'query',\n  ]),\n  generated: z.string(),\n  hash: z.string(),\n});\n\nexport const HybridSearchConfigSchema = z.object({\n  denseWeight: z.number().min(0).max(1),\n  bm25Weight: z.number().min(0).max(1),\n  userTunable: z.boolean(),\n}).refine(\n  (data) => Math.abs(data.denseWeight + data.bm25Weight - 1) < 0.001,\n  { message: 'Weights must sum to 1.0' }\n);\n\nexport const HybridSearchResultSchema = z.object({\n  nodeId: z.string(),\n  denseScore: z.number().min(0).max(1),\n  bm25Score: z.number().min(0).max(1),\n  fusedScore: z.number().min(0).max(1),\n});\n\nexport const SearchFiltersSchema = z.object({\n  timeRange: z.object({\n    start: z.string().datetime(),\n    end: z.string().datetime(),\n  }).optional(),\n  nodeTypes: z.array(z.string()).optional(),\n  clusterIds: z.array(z.string()).optional(),\n  excludeNodeIds: z.array(z.string()).optional(),\n});\n\nexport const QueryAnalysisSchema = z.object({\n  hasTimeReference: z.boolean(),\n  hasSemanticContent: z.boolean(),\n  expectedTypes: z.array(z.string()),\n  semanticPart: z.string(),\n  originalQuery: z.string(),\n});\n\nexport const SimilarityCheckResultSchema = z.object({\n  shouldCreateEdge: z.boolean(),\n  shouldCheckDedup: z.boolean(),\n  similarity: z.number().min(-1).max(1),\n  targetNodeId: z.string(),\n});\n\nexport const FallbackLevelSchema = z.enum(['primary', 'secondary', 'local', 'degraded']);\n\nexport const FallbackConfigSchema = z.object({\n  chain: z.array(z.string()),\n  retryDelayMs: z.number().int().positive(),\n  maxRetries: z.number().int().nonnegative(),\n  autoReEmbed: z.boolean(),\n});\n\nexport const ProviderHealthSchema = z.object({\n  isAvailable: z.boolean(),\n  lastSuccessAt: z.string().datetime().optional(),\n  lastFailureAt: z.string().datetime().optional(),\n  lastError: z.string().optional(),\n  consecutiveFailures: z.number().int().nonnegative(),\n});\n\n// ============================================================\n// DEFAULT CONFIGURATIONS\n// ============================================================\n\nexport const DEFAULT_HYBRID_CONFIG: HybridSearchConfig = {\n  denseWeight: DENSE_WEIGHT,\n  bm25Weight: BM25_WEIGHT,\n  userTunable: true,\n};\n\nexport const DEFAULT_MATRYOSHKA_CONFIG = {\n  stages: [\n    { stage: 1 as const, dimensions: 128 as const, candidates: STAGE_1_CANDIDATES, estimatedLatencyMs: 3 },\n    { stage: 2 as const, dimensions: 512 as const, candidates: STAGE_2_CANDIDATES, estimatedLatencyMs: 5 },\n    { stage: 3 as const, dimensions: 1536 as const, candidates: STAGE_3_CANDIDATES, estimatedLatencyMs: 7 },\n  ],\n  totalEstimatedLatencyMs: 15,\n};\n\nexport const DEFAULT_SIMILARITY_CONFIG: SimilarityEdgeConfig = {\n  edgeThreshold: SIMILARITY_EDGE_THRESHOLD,\n  dedupThreshold: DEDUP_CHECK_THRESHOLD,\n  staleThreshold: STALE_EDGE_THRESHOLD,\n  recentNodeWindow: RECENT_NODE_WINDOW,\n  comparisonDims: COMPARISON_DIMS,\n};\n\nexport const DEFAULT_FALLBACK_CONFIG: FallbackConfig = {\n  chain: [PRIMARY_MODEL, FALLBACK_1_MODEL, FALLBACK_2_MODEL],\n  retryDelayMs: FALLBACK_RETRY_DELAY_MS,\n  maxRetries: FALLBACK_MAX_RETRIES,\n  autoReEmbed: true,\n};\n\nexport const INITIAL_PROVIDER_HEALTH: ProviderHealth = {\n  isAvailable: true,\n  consecutiveFailures: 0,\n};\n\n/**\n * Context template definitions\n */\nexport const CONTEXT_TEMPLATES: Record<ContextPrefixTemplate, string> = {\n  concept_extracted: '[{subtype}] From {source} ({source_type}). {cluster}.',\n  concept_manual: '[{subtype}] Created by user. {cluster}.',\n  episode: '[{subtype}] {date}, {duration}min. {participants}.',\n  document_chunk: '[Chunk {index}/{total}] {parent}. Section: {section}.',\n  section: '[Section] {parent}. {title}.',\n  note: '[note] {cluster}. {title}.',\n  raw_archive: '[archive: {content_type}] {title}.',\n  query: '[Query] ',\n};\n\n/**\n * Time reference patterns for detection\n */\nexport const TIME_REFERENCE_PATTERNS = [\n  /\\b(yesterday|today|tomorrow)\\b/i,\n  /\\b(last|this|next)\\s+(week|month|year|monday|tuesday|wednesday|thursday|friday|saturday|sunday)\\b/i,\n  /\\b(in|during|on|at)\\s+\\d{4}\\b/i,\n  /\\b\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}\\b/,\n  /\\b(january|february|march|april|may|june|july|august|september|october|november|december)\\s+\\d{1,2}/i,\n  /\\b\\d+\\s+(days?|weeks?|months?|years?)\\s+ago\\b/i,\n];\n\n/**\n * Generic words to filter from semantic queries\n */\nexport const GENERIC_WORDS = [\n  'what', 'when', 'where', 'who', 'how', 'why',\n  'happened', 'did', 'was', 'is', 'are', 'were',\n  'tell', 'me', 'about', 'show', 'find', 'get',\n  'the', 'a', 'an', 'this', 'that', 'it',\n];\n\n// ============================================================\n// HASH FUNCTION\n// ============================================================\n\n/**\n * Compute a hash of the context prefix for change detection.\n * Simple but effective hash for fast comparison.\n */\nexport function hashContext(contextPrefix: string): string {\n  let hash = 0;\n  for (let i = 0; i < contextPrefix.length; i++) {\n    const char = contextPrefix.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(8, '0');\n}\n\n// ============================================================\n// NODE EMBEDDING FUNCTIONS\n// ============================================================\n\n/**\n * Create a new node embedding\n */\nexport function createNodeEmbedding(\n  vector: Float32Array,\n  model: EmbeddingModelId,\n  contextPrefix: string,\n  provisional = false\n): NodeEmbedding {\n  return {\n    vector,\n    dimensions: vector.length,\n    model,\n    contextPrefix,\n    contextHash: hashContext(contextPrefix),\n    createdAt: new Date().toISOString(),\n    provisional,\n    version: 1,\n  };\n}\n\n/**\n * Check if an embedding is provisional\n */\nexport function isProvisional(embedding: NodeEmbedding): boolean {\n  return embedding.provisional;\n}\n\n/**\n * Check if an embedding needs re-embedding due to context changes\n */\nexport function needsReEmbedding(\n  embedding: NodeEmbedding,\n  currentContextHash: string\n): boolean {\n  return embedding.contextHash !== currentContextHash;\n}\n\n/**\n * Check if an embedding uses the primary model\n */\nexport function isPrimaryModel(embedding: NodeEmbedding): boolean {\n  return embedding.model === PRIMARY_MODEL;\n}\n\n/**\n * Update an embedding (increments version)\n */\nexport function updateEmbedding(\n  previous: NodeEmbedding,\n  vector: Float32Array,\n  model: EmbeddingModelId,\n  contextPrefix: string,\n  provisional = false\n): NodeEmbedding {\n  return {\n    ...createNodeEmbedding(vector, model, contextPrefix, provisional),\n    version: previous.version + 1,\n  };\n}\n\n/**\n * Truncate embedding vector to Matryoshka dimension\n */\nexport function truncateToMatryoshka(\n  embedding: NodeEmbedding,\n  dims: 128 | 512 | 1536\n): Float32Array {\n  if (dims >= embedding.dimensions) {\n    return embedding.vector;\n  }\n  return embedding.vector.slice(0, dims);\n}\n\n/**\n * Get dimensions for a model\n */\nexport function getModelDimensions(model: EmbeddingModelId): number {\n  switch (model) {\n    case 'openai-3-small':\n      return 1536;\n    case 'voyage-3-lite':\n      return 512;\n    case 'minilm-v6':\n      return 384;\n    default:\n      return EMBEDDING_DIMENSIONS;\n  }\n}\n\n// ============================================================\n// CONTEXT PREFIX FUNCTIONS\n// ============================================================\n\n/**\n * Select the appropriate template for a node\n */\nexport function selectTemplate(\n  nodeType: string,\n  sourceType?: 'extraction' | 'manual' | 'inference' | 'import'\n): ContextPrefixTemplate {\n  switch (nodeType) {\n    case 'concept':\n      return sourceType === 'extraction' ? 'concept_extracted' : 'concept_manual';\n    case 'episode':\n      return 'episode';\n    case 'chunk':\n      return 'document_chunk';\n    case 'section':\n      return 'section';\n    case 'note':\n      return 'note';\n    case 'raw':\n    case 'document':\n      return 'raw_archive';\n    default:\n      return 'concept_manual';\n  }\n}\n\n/**\n * Format a date for context prefix\n */\nexport function formatContextDate(timestamp: string): string {\n  const date = new Date(timestamp);\n  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',\n                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n  return `${months[date.getMonth()]} ${date.getDate()} ${date.getFullYear()}`;\n}\n\n/**\n * Generate context prefix for a node\n */\nexport function generateContextPrefix(input: ContextGeneratorInput): ContextPrefix {\n  const template = selectTemplate(input.nodeType, input.sourceType);\n  let generated = CONTEXT_TEMPLATES[template];\n\n  // Replace placeholders\n  generated = generated.replace('{subtype}', input.nodeSubtype || input.nodeType);\n  generated = generated.replace('{source}', input.sourceEpisode?.title || '');\n  generated = generated.replace('{source_type}', input.sourceEpisode?.subtype || '');\n  generated = generated.replace('{cluster}', input.clusterInfo?.name || '');\n  generated = generated.replace('{date}', input.eventTimestamp\n    ? formatContextDate(input.eventTimestamp)\n    : '');\n  generated = generated.replace('{duration}', String(input.durationMinutes || 0));\n  generated = generated.replace('{participants}', input.participants?.join(', ') || '');\n  generated = generated.replace('{index}', String(input.chunkInfo?.index || 0));\n  generated = generated.replace('{total}', String(input.chunkInfo?.total || 0));\n  generated = generated.replace('{parent}', input.chunkInfo?.parentTitle || '');\n  generated = generated.replace('{section}', input.chunkInfo?.sectionTitle || 'Main');\n  generated = generated.replace('{content_type}', input.contentType || 'unknown');\n  generated = generated.replace('{title}', input.title);\n\n  // Clean up empty segments\n  generated = generated.replace(/\\(\\)\\.?/g, '');\n  generated = generated.replace(/\\s+/g, ' ');\n  generated = generated.trim();\n\n  return {\n    template,\n    generated,\n    hash: hashContext(generated),\n  };\n}\n\n/**\n * Expand short content with additional context\n */\nexport function expandMinimumContext(\n  content: string,\n  prefix: string,\n  clusterInfo?: { name: string; description?: string; keywords?: string[] }\n): string {\n  let expandedPrefix = prefix;\n\n  if (content.length < MIN_CONTENT_LENGTH && clusterInfo?.description) {\n    expandedPrefix += ` Topic: ${clusterInfo.description}.`;\n  }\n\n  if (\n    (content.length + expandedPrefix.length) < MIN_TOTAL_LENGTH &&\n    clusterInfo?.keywords?.length\n  ) {\n    const keywords = clusterInfo.keywords.slice(0, 5).join(', ');\n    expandedPrefix += ` Keywords: ${keywords}.`;\n  }\n\n  return expandedPrefix;\n}\n\n/**\n * Generate query prefix\n */\nexport function generateQueryPrefix(semanticContent: string): ContextPrefix {\n  const generated = `[Query] ${semanticContent}`;\n  return {\n    template: 'query',\n    generated,\n    hash: hashContext(generated),\n  };\n}\n\n/**\n * Combine prefix and content for embedding\n */\nexport function combineForEmbedding(\n  prefix: string,\n  content: string,\n  clusterInfo?: { name: string; description?: string; keywords?: string[] }\n): string {\n  const expandedPrefix = expandMinimumContext(content, prefix, clusterInfo);\n  return `${expandedPrefix} ${content}`.trim();\n}\n\n// ============================================================\n// HYBRID SEARCH FUNCTIONS\n// ============================================================\n\n/**\n * Get default hybrid search configuration\n */\nexport function getDefaultHybridConfig(): HybridSearchConfig {\n  return { ...DEFAULT_HYBRID_CONFIG };\n}\n\n/**\n * Fuse dense and BM25 scores\n */\nexport function fuseScores(\n  denseScore: number,\n  bm25Score: number,\n  config: HybridSearchConfig = DEFAULT_HYBRID_CONFIG\n): number {\n  return (denseScore * config.denseWeight) + (bm25Score * config.bm25Weight);\n}\n\n/**\n * Normalize scores to 0-1 range\n */\nexport function normalizeScores(\n  results: HybridSearchResult[]\n): HybridSearchResult[] {\n  if (results.length === 0) return [];\n\n  const denseScores = results.map((r) => r.denseScore);\n  const bm25Scores = results.map((r) => r.bm25Score);\n\n  const denseMin = Math.min(...denseScores);\n  const denseMax = Math.max(...denseScores);\n  const bm25Min = Math.min(...bm25Scores);\n  const bm25Max = Math.max(...bm25Scores);\n\n  const denseRange = denseMax - denseMin || 1;\n  const bm25Range = bm25Max - bm25Min || 1;\n\n  return results.map((result) => ({\n    ...result,\n    denseScore: (result.denseScore - denseMin) / denseRange,\n    bm25Score: (result.bm25Score - bm25Min) / bm25Range,\n  }));\n}\n\n/**\n * Create a search result\n */\nexport function createSearchResult(\n  nodeId: string,\n  denseScore: number,\n  bm25Score: number,\n  config: HybridSearchConfig = DEFAULT_HYBRID_CONFIG\n): HybridSearchResult {\n  return {\n    nodeId,\n    denseScore,\n    bm25Score,\n    fusedScore: fuseScores(denseScore, bm25Score, config),\n  };\n}\n\n/**\n * Sort results by fused score descending\n */\nexport function sortByFusedScore(\n  results: HybridSearchResult[]\n): HybridSearchResult[] {\n  return [...results].sort((a, b) => b.fusedScore - a.fusedScore);\n}\n\n/**\n * Take top k results\n */\nexport function takeTopK(\n  results: HybridSearchResult[],\n  k: number\n): HybridSearchResult[] {\n  return sortByFusedScore(results).slice(0, k);\n}\n\n/**\n * Validate hybrid config\n */\nexport function validateHybridConfig(config: HybridSearchConfig): boolean {\n  return Math.abs(config.denseWeight + config.bm25Weight - 1) < 0.001;\n}\n\n// ============================================================\n// QUERY PROCESSING FUNCTIONS\n// ============================================================\n\n/**\n * Detect if a query contains time references\n */\nexport function detectTimeReference(query: string): boolean {\n  return TIME_REFERENCE_PATTERNS.some((pattern) => pattern.test(query));\n}\n\n/**\n * Remove time references from query\n */\nexport function removeTimeReferences(query: string): string {\n  let result = query;\n  for (const pattern of TIME_REFERENCE_PATTERNS) {\n    result = result.replace(pattern, '');\n  }\n  return result.replace(/\\s+/g, ' ').trim();\n}\n\n/**\n * Remove generic words from query\n */\nexport function removeGenericWords(query: string): string {\n  const words = query.toLowerCase().split(/\\s+/);\n  const filtered = words.filter((word) => !GENERIC_WORDS.includes(word));\n  return filtered.join(' ');\n}\n\n/**\n * Infer expected node types from query\n */\nexport function inferExpectedTypes(query: string): string[] {\n  const types: string[] = [];\n  const lower = query.toLowerCase();\n\n  if (lower.includes('lecture') || lower.includes('class') || lower.includes('meeting')) {\n    types.push('episode');\n  }\n  if (lower.includes('concept') || lower.includes('idea') || lower.includes('fact')) {\n    types.push('concept');\n  }\n  if (lower.includes('note') || lower.includes('wrote')) {\n    types.push('note');\n  }\n  if (lower.includes('document') || lower.includes('file') || lower.includes('pdf')) {\n    types.push('document', 'chunk');\n  }\n\n  if (types.length === 0) {\n    types.push('concept', 'episode', 'note');\n  }\n\n  return types;\n}\n\n/**\n * Analyze a raw query\n */\nexport function analyzeQuery(rawQuery: string): QueryAnalysis {\n  const hasTimeReference = detectTimeReference(rawQuery);\n  const semanticPart = hasTimeReference\n    ? removeTimeReferences(rawQuery)\n    : rawQuery;\n  const cleanedSemantic = removeGenericWords(semanticPart);\n  const hasSemanticContent = cleanedSemantic.length >= 3;\n\n  return {\n    hasTimeReference,\n    hasSemanticContent,\n    expectedTypes: inferExpectedTypes(rawQuery),\n    semanticPart: cleanedSemantic,\n    originalQuery: rawQuery,\n  };\n}\n\n/**\n * Determine if query should skip embedding\n */\nexport function shouldSkipEmbedding(analysis: QueryAnalysis): boolean {\n  return analysis.hasTimeReference && !analysis.hasSemanticContent;\n}\n\n/**\n * Tokenize text for BM25 search\n */\nexport function tokenizeForBM25(text: string): string[] {\n  const normalized = text.toLowerCase();\n  const tokens = normalized\n    .split(/[\\s\\-_.,;:!?'\"()\\[\\]{}]+/)\n    .filter((token) => token.length > 1);\n  return tokens;\n}\n\n// ============================================================\n// SIMILARITY FUNCTIONS\n// ============================================================\n\n/**\n * Compute cosine similarity between two vectors\n */\nexport function cosineSimilarity(a: Float32Array, b: Float32Array): number {\n  if (a.length !== b.length) {\n    throw new Error(`Vector length mismatch: ${a.length} vs ${b.length}`);\n  }\n\n  let dotProduct = 0;\n  let normA = 0;\n  let normB = 0;\n\n  for (let i = 0; i < a.length; i++) {\n    dotProduct += a[i]! * b[i]!;\n    normA += a[i]! * a[i]!;\n    normB += b[i]! * b[i]!;\n  }\n\n  const denominator = Math.sqrt(normA) * Math.sqrt(normB);\n  if (denominator === 0) return 0;\n\n  return dotProduct / denominator;\n}\n\n/**\n * Truncate vector for fast comparison\n */\nexport function truncateForComparison(\n  vector: Float32Array,\n  dims: number\n): Float32Array {\n  if (dims >= vector.length) return vector;\n  return vector.slice(0, dims);\n}\n\n/**\n * Check similarity between embeddings\n */\nexport function checkSimilarity(\n  sourceEmbedding: NodeEmbedding,\n  targetEmbedding: NodeEmbedding,\n  targetNodeId: string,\n  config: SimilarityEdgeConfig = DEFAULT_SIMILARITY_CONFIG\n): SimilarityCheckResult {\n  const sourceVec = truncateForComparison(\n    sourceEmbedding.vector,\n    config.comparisonDims\n  );\n  const targetVec = truncateForComparison(\n    targetEmbedding.vector,\n    config.comparisonDims\n  );\n\n  const similarity = cosineSimilarity(sourceVec, targetVec);\n\n  return {\n    shouldCreateEdge: similarity >= config.edgeThreshold,\n    shouldCheckDedup: similarity >= config.dedupThreshold,\n    similarity,\n    targetNodeId,\n  };\n}\n\n/**\n * Check if edge is stale\n */\nexport function isStaleEdge(\n  currentSimilarity: number,\n  config: SimilarityEdgeConfig = DEFAULT_SIMILARITY_CONFIG\n): boolean {\n  return currentSimilarity < config.staleThreshold;\n}\n\n/**\n * Sort results by similarity descending\n */\nexport function sortBySimilarity(\n  results: SimilarityCheckResult[]\n): SimilarityCheckResult[] {\n  return [...results].sort((a, b) => b.similarity - a.similarity);\n}\n\n// ============================================================\n// FALLBACK FUNCTIONS\n// ============================================================\n\n/**\n * Get fallback level for a model\n */\nexport function getFallbackLevel(modelId: EmbeddingModelId): FallbackLevel {\n  switch (modelId) {\n    case PRIMARY_MODEL:\n      return 'primary';\n    case FALLBACK_1_MODEL:\n      return 'secondary';\n    case FALLBACK_2_MODEL:\n      return 'local';\n    default:\n      return 'degraded';\n  }\n}\n\n/**\n * Determine if an error is retryable\n */\nexport function shouldRetry(error: Error, statusCode?: number): boolean {\n  if (statusCode === 429) return true;\n  if (statusCode && statusCode >= 500 && statusCode < 600) return true;\n  if (error.message.includes('ECONNREFUSED')) return true;\n  if (error.message.includes('ETIMEDOUT')) return true;\n  if (error.message.includes('network')) return true;\n  if (statusCode === 401 || statusCode === 403) return false;\n  if (statusCode === 400) return false;\n  return false;\n}\n\n/**\n * Get next provider in fallback chain\n */\nexport function getNextProvider(\n  currentModel: EmbeddingModelId,\n  config: FallbackConfig = DEFAULT_FALLBACK_CONFIG\n): EmbeddingModelId | null {\n  const currentIndex = config.chain.indexOf(currentModel);\n  if (currentIndex === -1 || currentIndex >= config.chain.length - 1) {\n    return null;\n  }\n  return config.chain[currentIndex + 1] ?? null;\n}\n\n/**\n * Create initial fallback state\n */\nexport function createInitialFallbackState(): FallbackState {\n  const providerHealth: Record<string, ProviderHealth> = {};\n  for (const model of EMBEDDING_MODELS) {\n    providerHealth[model] = { ...INITIAL_PROVIDER_HEALTH };\n  }\n\n  return {\n    currentLevel: 'primary',\n    recoveryAttempts: 0,\n    providerHealth,\n  };\n}\n\n/**\n * Record provider success\n */\nexport function recordSuccess(\n  state: FallbackState,\n  provider: EmbeddingModelId\n): FallbackState {\n  const newHealth: ProviderHealth = {\n    ...state.providerHealth[provider],\n    isAvailable: true,\n    lastSuccessAt: new Date().toISOString(),\n    consecutiveFailures: 0,\n  };\n\n  const newLevel = provider === PRIMARY_MODEL ? 'primary' : state.currentLevel;\n\n  return {\n    ...state,\n    currentLevel: newLevel,\n    providerHealth: { ...state.providerHealth, [provider]: newHealth },\n    degradedSince: newLevel === 'primary' ? undefined : state.degradedSince,\n  };\n}\n\n/**\n * Record provider failure\n */\nexport function recordFailure(\n  state: FallbackState,\n  provider: EmbeddingModelId,\n  error: string\n): FallbackState {\n  const currentHealth = state.providerHealth[provider] || INITIAL_PROVIDER_HEALTH;\n  const newHealth: ProviderHealth = {\n    ...currentHealth,\n    isAvailable: false,\n    lastFailureAt: new Date().toISOString(),\n    lastError: error,\n    consecutiveFailures: currentHealth.consecutiveFailures + 1,\n  };\n\n  let newLevel = state.currentLevel;\n  if (provider === PRIMARY_MODEL && state.currentLevel === 'primary') {\n    newLevel = 'secondary';\n  }\n\n  return {\n    ...state,\n    currentLevel: newLevel,\n    lastError: error,\n    providerHealth: { ...state.providerHealth, [provider]: newHealth },\n    degradedSince: state.degradedSince || new Date().toISOString(),\n    recoveryAttempts: state.recoveryAttempts + 1,\n  };\n}\n\n/**\n * Create degraded result (no embedding)\n */\nexport function createDegradedResult(error: string, latencyMs: number): EmbedResult {\n  return {\n    embedding: null,\n    fallbackLevel: 'degraded',\n    error,\n    latencyMs,\n    isProvisional: false,\n  };\n}\n\n/**\n * Create success result\n */\nexport function createSuccessResult(\n  embedding: NodeEmbedding,\n  modelUsed: EmbeddingModelId,\n  latencyMs: number\n): EmbedResult {\n  const level = getFallbackLevel(modelUsed);\n  return {\n    embedding,\n    fallbackLevel: level,\n    modelUsed,\n    latencyMs,\n    isProvisional: level !== 'primary',\n  };\n}\n\n// ============================================================\n// COST ESTIMATION\n// ============================================================\n\n/**\n * Estimate embedding cost\n */\nexport function estimateCost(\n  tokens: number,\n  costPer1M = 0.02\n): { tokens: number; costUsd: number } {\n  return {\n    tokens,\n    costUsd: (tokens / 1_000_000) * costPer1M,\n  };\n}\n\n/**\n * Estimate monthly cost\n */\nexport function estimateMonthlyCost(\n  nodesPerDay: number,\n  queriesPerDay: number,\n  tokensPerNode = 150,\n  tokensPerQuery = 30,\n  costPer1M = 0.02\n): { tokens: number; costUsd: number } {\n  const dailyNodeTokens = nodesPerDay * tokensPerNode;\n  const dailyQueryTokens = queriesPerDay * tokensPerQuery;\n  const monthlyTokens = (dailyNodeTokens + dailyQueryTokens) * 30;\n  return estimateCost(monthlyTokens, costPer1M);\n}\n"]}